<template>
	<div class="page" data-name="recovery" id="recovery">
		<div class="artwork"></div>
        <div class="navbar">
			<div class="navbar-inner sliding">
				<div class="header-cont">
					<div class="header">
						<a href="" class="back-btn back">
							<i class="icons material-icons">chevron_left</i>
						</a>
						<h1 class="title">{{localize "forgot_pass"}}</h1>
						<div class="none"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="page-content" id="recovery">
			<div class="sqr_bck" id="sqr1"></div>
			<div class="sqr_bck" id="sqr2"></div>
			<div class="sqr_bck" id="sqr3"></div>
			<div class="logo-cont">
				<div class="logo">
					<div class="background"></div>
					<img src="static/img/Pluma.png" alt="" />
				</div>
			</div>
			<div class="text-cont">
				<p class="text">
					{{localize "text_forgot_pass"}}
				</p>
			</div>
			<div class="inputs list">
				<ul>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="email" id="email" placeholder='{{localize "mail"}}' required validate />
								<i class="icons material-icons">edit</i>
								<!-- <span class="input-clear-button"></span> -->
							</div>
						</div>
					</li>
				</ul>
			</div>
			<div class="btns-cont center">
				<a id="recover-pass-btn" href="" class="button round color-blue large">{{localize "recover_pass"}}</a>
			</div>
		</div>
	</div>
</template>
<script>
    import $$ from "dom7";
    export default {
        on: {
            pageInit: async function(e, page) {
                var self = this;
                var app = self.$app;
                // var isEditing = page.route.context.IsEditing;
                // var currentUser = page.route.context.CurrentUser;

                // /recovery/mailSend
				function validateEmail(mail) {
								console.log("Mail to validate ", mail);
								// if (/^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/.test(mail))
								// if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)z*(\.\w{2,3})+$/.test(mail))
								// if (/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/.test(mail))
								// if (/^[^@]+@[^@]+\.[a-zA-Z]{2,}$/.test(mail)) {

								if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(mail)) {
												return (true);
								}
								// alert("You have entered an invalid email address!")
								return (false);
				}
                $$('#recover-pass-btn').off('click').click(function(val) {
                    console.log("Ayyy click");
                    let emailVal = $$('#email').val();
                    console.log("EmailVal: ", emailVal);
                    if (validateEmail(emailVal)) {
                        console.log("Doing the email thing");
                        app.request.promise.post(`${app.data.server}/auth/forgot-password`, {
                            email: emailVal
                        }).then(function(res) {
                            console.log("email sent");
                            console.log(res);
                            app.views.main.router.navigate('/recovery/mailSend');
                        }).catch(function(err) {
                            console.log("Error sending email");
                            console.log(err);
                        });
                    } else {
                        app.dialog.alert(window.localize("recovery_invalid_email"));
                    }
                });

                
            },
        },
    };
</script>