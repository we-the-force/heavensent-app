<template>
	<div class="page" data-name="login-screen" id="login-screen">
		<div class="artwork"></div>
		<div class="page-content" id="login-screen">
			<div class="sqr_bck" id="sqr1"></div>
			<div class="sqr_bck" id="sqr2"></div>
			<div class="sqr_bck" id="sqr3"></div>
			<div class="sqr_bck" id="sqr4"></div>
			<div class="logo-cont">
				<img src="static/img/LOGO.svg" alt="" class="logo" id="title" />
			</div>
			<div class="inputs list">
				<ul>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="email" id="email" placeholder='{{localize "mail"}}' required validate />
								<i class="icons material-icons">edit</i>
								<!-- <span class="input-clear-button"></span> -->
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="password" id="password" placeholder='{{localize "pass"}}' required validate />
								<i id="pass-edit-icon" class="icons material-icons">edit</i>
								<span class="show" style="display: none;">Show</span>
								<!-- <span class="input-clear-button"></span> -->
							</div>
						</div>
					</li>
				</ul>
			</div>
			<div class="btns-cont center face none">
				<a class="button round color-white face">Login with Facebook</a>
			</div>
			<div class="btns-cont two">
				<!-- <a class="button round color-white small" href="/signup/step1">Sing up</a> -->
				<a class="button round color-white small" href="/UserAgreement">{{localize "sign_up"}}</a>
				<a id="login-btn" class="button round color-blue small">{{localize "login"}}</a>
			</div>
			<div class="btns-cont center pass">
				<a class="button link color-blue" href="/recovery/">{{localize "forgot_pass"}}</a>
			</div>
			<div id="paybtn"></div>
		</div>
	</div>
</template>
<script>
	import $$ from "dom7";
	import localforage from "localforage";


	export default {
		on: {
			pageBeforeIn: async function(){
				var self = this;
				var app = self.$app;
				
				console.log("---pageBeforeIn, updating user")
				var localUser = await app.methods.getLocalValue('loggedUser');
				if (localUser != null)
				{
					app.request.promise.get(`${app.data.server}/users/${localUser.id}`).then(async function(getResult){
						let user = JSON.parse(getResult.data);
						
						if (user.confirmed)
						{
							
						}
						else
						{
							app.dialog.alert(`That user is no longer confirmed! Please check your email or contact an admin`);
						}
					}).catch(async function(error){
						let result = await app.methods.clearCurrentUser();
						if (result === true)
						{
							console.log("Cleared user data succesfully [pageBeforeIn]");
						}
						else
						{
							console.log("Couldn't clear user [pageBeforeIn]");
						}
					})
				}
				else
				{
					console.log("User wasn't logged in [pageBeforeIn]");
				}
				
				function isTextEmptyOrWhitespace(value)
				{
					if (!value || !value.trim())
					{
						return true;
					}
					return false;
				}
			},
			pageInit: async function (e, page) {
				var self = this;
				var emailInputValue = "";
				var passwordInputValue = "";
				function getBrowserLocales(options = {}) {
					const defaultOptions = {
							languageCodeOnly: false,
					};

					const opt = {
							...defaultOptions,
							...options,
					};

					const browserLocales =
							navigator.languages === undefined
									? [navigator.language]
									: navigator.languages;

					if (!browserLocales) {
							return undefined;
					}

					return browserLocales.map(locale => {
							const trimmedLocale = locale.trim();

							return opt.languageCodeOnly
									? trimmedLocale.split(/-|_/)[0]
									: trimmedLocale;
					});
				}
				var app = self.$app;
				console.log(getBrowserLocales());
				console.log(window.language);
				if (window.language == 'es_MX') {
					$$('#login-btn').css('font-size', '14px');
				}

				$$(".show").click(function (val) {
					let type = $$("#password").attr("type");
					if (type == "password") {
						$$("#password").attr("type", "text");
					} else {
						$$("#password").attr("type", "password");
					}
				});

				////mostrar span de show
				$$("#password").on("input:notempty", function (val) {
					$$(".show").css("display", "block");
					$$("#pass-edit-icon").css("display", "none");
				});

				////ocultar span cuando el input este vacio
				$$("#signup-password").on("input:empty", function (val) {
					$$(".show").css("display", "none");
					$$("#pass-edit-icon").css("display", "block");
				});
				
				$$("#login-btn").on("click", async function (e) {
					e.preventDefault();
					emailInputValue = $$("#email").val();
					passwordInputValue = $$("#password").val();
					
					if (!validateEmail(emailInputValue, 'enter a valid email'))
					{
						console.log('username not valid [pageInit.login-btn.onClick]');
						return false;
					}
					if (!validateText(passwordInputValue, 'enter a valid password'))
					{
						console.log('password not valid [pageInit.login-btn.onClick]');
						return false;
					}
					
					app.preloader.show("blue");
					// console.log(`Posting to "${app.data.server}/auth/local"`);
					app.request.promise.postJSON(app.data.server + "/auth/local", {
						identifier: emailInputValue,
						password: passwordInputValue,
					})
					.then(async function (res) {
						console.log("Getting inside 'then' [pageInit.login-btn.onClick]");
						console.log(res);
						app.preloader.hide();
						
						let user = res.data.user;
						if (!user.confirmed)
						{
							app.dialog.alert("This account has not been confirmed yet, please check your email");
							return false;
						}
						else
						{
							console.log("Setting logged user to localStorage [pageInit.login-btn.onClick]");
							if (await app.methods.setLocalValueToKey(user, 'loggedUser'))
							{
								let hasAdmin = await app.methods.userHasAdmin();
								console.log("Has admin? [pageInit.login-btn.onClick]");
								console.log(hasAdmin);
								if (hasAdmin)
								{
									console.log("Successfully logged in [pageInit.login-btn.onClick]");
									// console.log(await app.methods.getLocalValue('loggedUser'))
									
									if (await app.methods.userHasValidMembership())
									{
										await app.methods.loadContacts();
										await app.methods.loadAdminedContacts();
										console.log("User has a valid membership! [pageInit.login-btn.onClick]");
										// app.views.main.router.navigate({ name: "home-memories" });
										app.views.main.router.navigate(`/memories/home/user/${user.id}`);
									}
									else
									{
										console.log("User doesn't have a valid membership! [pageInit.login-btn.onClick]");
										await app.views.main.router.navigate({
											name: 'select-membership',
											params: { 
												userID: user.id,
												clearOnBack: "1"
											}
										})
									}
									
								}
								else
								{
									app.dialog.alert('Your account has no admin assigned to it currently, please fill out your admin info.');
									await app.views.main.router.navigate({
										name: 'invite-admin',
										params: { userID: user.id }
									})
								}
							}
							else
							{
								console.log("Couldn't set the user");
							}
						}
					})
					.catch(async function (err) {
						app.preloader.hide();
						console.log("Errorerror [pageInit.login-btn.onClick]");
						console.log(err);
						var obj = JSON.parse(err.xhr.response);
						app.dialog.alert('Some fields are incomplete or incorrect, please try again.'+'\r\n'+obj.message[0].messages[0].message);
					});
				});
				
				function validateEmail(mail, errorText) 
				{
					if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mail))
					{
						return (true);
					}
					app.dialog.alert(errorText);
					return (false);
				}
				function validateText(text, emptyText, trimmedText, checkTrimmed = true)
				{
					if (isTextEmptyOrWhitespace(text))
					{
						app.dialog.alert(emptyText);
						return false;
					}
					else
					{
						if (checkTrimmed)
						{
							if (!isTextTrimmed(text))
							{
								app.dialog.alert(trimmedText);
								return false;
							}
						}
						return true;
					}
				}
				function isTextEmptyOrWhitespace(value)
				{
					if (!value || !value.trim())
					{
						return true;
					}
					return false;
				}
				
				function isTextTrimmed(value)
				{
					return (value == value.trim());
				}
			},
		},
	};
</script>