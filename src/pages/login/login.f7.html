<template>
	<div class="page" data-name="login-screen" id="login-screen">
		<div class="artwork"></div>
		<div class="page-content" id="login-screen">
			<div class="sqr_bck" id="sqr1"></div>
			<div class="sqr_bck" id="sqr2"></div>
			<div class="sqr_bck" id="sqr3"></div>
			<div class="sqr_bck" id="sqr4"></div>
			<div class="logo-cont">
				<img src="../../static/img/LOGO.png" alt="" class="logo" id="title" />
			</div>
			<div class="inputs list">
				<ul>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="email" id="email" placeholder="e-mail" required validate />
								<i class="icons material-icons">edit</i>
								<!-- <span class="input-clear-button"></span> -->
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="password" id="password" placeholder="Password" required validate />
								<i class="icons material-icons">edit</i>
								<!-- <span class="input-clear-button"></span> -->
							</div>
						</div>
					</li>
				</ul>
			</div>
			<div class="btns-cont center face">
				<a class="button round color-white face">Login with Facebook</a>
			</div>
			<div class="btns-cont two">
				<a class="button round color-white small" href="/signup/step1">Sing up</a>
				<!-- <a class="button round color-white small" href="/membership/select">Sing up</a> -->
				<a id="login-btn" class="button round color-blue small">Login</a>
			</div>
			<div class="btns-cont center pass">
				<a class="button link color-blue" href="/recovery/">Forgot password?</a>
			</div>
		</div>
	</div>
</template>
<script>
	import $$ from "dom7";
	import localforage from "localforage";
	export default {
		on: {
			pageBeforeIn: async function(){
				var self = this;
				var app = self.$app;
				
				console.log("Before In");
				var localUser = await app.methods.getLocalValue('loggedUser');
				if (localUser != -1)
				{
					console.log("User was logged in");
					app.request.promise.get(`${app.data.server}/users/${localUser.id}`).then(function(getResult){
						console.log("get request");
						console.log(getResult);
						let user = JSON.parse(getResult.data);
						console.log("User gotten from get request");
						console.log(user);
						if (user.confirmed)
						{
							console.log("User was logged in, skipping to dashboard");
							app.views.main.router.navigate({ name: "home-memories" });
						}
						else
						{
							app.dialog.alert(`That user is no longer active!`);
						}
					}).catch(function(error){
						app.dialog.alert(`This user was not found or no longer exists!`);
					})
				}
				else
				{
					console.log("User wasn't logged in");
				}
				
				function isTextEmptyOrWhitespace(value)
				{
					if (!value || !value.trim())
					{
						return true;
					}
					return false;
				}
			},
			pageInit: async function (e, page) {
				var self = this;
				// console.log(this);
				var emailInputValue = "";
				var passwordInputValue = "";

				// $$('#email').val('will@wetheforce.com');
				// $$('#password').val('123456789');
				// emailInputValue=$$('#email').val();
				
				var app = self.$app;
				
				localforage.keys().then(function(keys) {
					// An array of all the key names.
					console.log(keys);
				}).catch(function(err) {
					// This code runs if there were any errors
					console.log(err);
				});
				
				console.log("Init");
				
				$$("#login-btn").on("click", async function (e) {
					e.preventDefault();
					emailInputValue = $$("#email").val();
					passwordInputValue = $$("#password").val();
					
					if (!validateEmail(emailInputValue, 'enter a valid email'))
					{
						console.log('username not valid');
						return false;
					}
					if (!validateText(passwordInputValue, 'enter a valid password'))
					{
						console.log('password not valid');
						return false;
					}
					
					app.preloader.show("blue");
					// console.log(`Posting to "${app.data.server}/auth/local"`);
					app.request.promise.postJSON(app.data.server + "/auth/local", {
						identifier: emailInputValue,
						password: passwordInputValue,
					})
					.then(async function (res) {
						console.log("Getting inside 'then'");
						console.log(res);
						app.preloader.hide();
						
						let user = res.data.user;
						if (!user.confirmed)
						{
							app.dialog.alert("This account has not been confirmed yet, please check your email");
							return false;
						}
						else
						{
							console.log("localForage");
							if (await app.methods.setLocalValueToKey(user, 'loggedUser'))
							{
								console.log("Successfully logged in");
								console.log(await app.methods.getLocalValue('loggedUser'))
								app.views.main.router.navigate({ name: "home-memories" });
							}
						}
					})
					.catch(async function (err) {
						console.log("Errorerror");
						app.preloader.hide();
						console.log(err);
						var obj = JSON.parse(err.xhr.response);
						app.dialog.alert('Some fields are incomplete or incorrect, please try again.'+'\r\n'+obj.message[0].messages[0].message);
					});
				});
				
				function validateEmail(mail, errorText) 
				{
					if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mail))
					{
						return (true);
					}
					app.dialog.alert(errorText);
					return (false);
				}
				function validateText(text, emptyText, trimmedText, checkTrimmed = true)
				{
					console.log(`${text}, trim?: ${checkTrimmed}`);
					if (isTextEmptyOrWhitespace(text))
					{
						app.dialog.alert(emptyText);
						return false;
					}
					else
					{
						if (checkTrimmed)
						{
							if (!isTextTrimmed(text))
							{
								app.dialog.alert(trimmedText);
								return false;
							}
						}
						return true;
					}
				}
				function isTextEmptyOrWhitespace(value)
				{
					if (!value || !value.trim())
					{
						return true;
					}
					return false;
				}
				
				function isTextTrimmed(value)
				{
					return (value == value.trim());
				}
			},
		},
	};
</script>