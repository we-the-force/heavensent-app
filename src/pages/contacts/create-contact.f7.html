<template>
	<div class="page" data-name="create-contact" id="create-contact">
		<div class="artwork"></div>
		<div class="navbar">
			<div class="navbar-inner sliding">
				<div class="header-cont">
					<div class="header">
						<a href="" class="back-btn back">
							<i class="icons material-icons">chevron_left</i>
						</a>
						<h1 class="title">Create family member</h1>
						<div class="none"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="page-content">
			<div class="sqr_bck" id="sqr1"></div>
			<div class="sqr_bck" id="sqr2"></div>
			<div class="sqr_bck" id="sqr3"></div>
			<div class="upload-cont">
				<div class="upload-img">
					<div class="photo"></div>
				</div>
				<label class="img-btn" for="file-upload">
					<i class="icons material-icons">photo_camera</i>
					<input id="file-upload" type="file" style="display: none;" />
				</label>
			</div>
			<div class="inputs list">
				<ul>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="text" id="create-cont-name" placeholder="name" required validate />
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="email" id="create-cont-email" placeholder="email" required validate />
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="text" id="create-cont-mobile" placeholder="mobile" required validate />
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="text" id="create-cont-relation" placeholder="relation" required validate />
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="date" id="create-cont-birthday" placeholder="birthday" required validate />
							</div>
						</div>
					</li>
					<!-- falta checar la edad -->
				</ul>
			</div>
			<div class="btns-cont center">
				<a href="/guardian/create" id="create-guardian-btn" class="button color-white round large">Select / Create guardian</a>
			</div>
			<div class="btns-cont center">
				<a id="create-member-btn" class="button color-blue round large">Create a member</a>
			</div>
			<div class="footer">
				<div class="sqr_bck" id="sqr4"></div>
				<div class="sqr_bck" id="sqr5"></div>
			</div>
		</div>
	</div>
</template>
<script>
	import $$ from "dom7";
	import croppie from "croppie";
	export default {
		on: {
			pageInit: async function (e, page) {
				var self = this;
				var app = self.$app;
				
				var loggedUser = await app.methods.getLocalValue('loggedUser');
				
				var c;
				var username = "";
				var email="";
				var mobile="";
				var relation="";
				var birthday="";
				var isAdmin="";
				var editMemories="";
				var isMinor="";
				
				// $$("#create-cont-name").val("Test4123");
				// $$("#create-cont-email").val("Test4123@123.com");
				// $$("#create-cont-mobile").val("123456789123");
				// $$("#create-cont-relation").val("Hijuesu");
				// $$("#create-cont-birthday").val();
				// $$("#create-cont-is-admin").val();
				// $$("#create-cont-edit-memories").val();
				// $$("#create-cont-is-minor").val("off");
				
				//upload photo
				$$(".img-btn").on("click", function () {
					if (window.File && window.FileReader && window.FormData) {
						var inputField = $$("#file-upload");
						inputField.off("change");
						inputField.on("change", function (e) {
							var file = e.target.files[0];
							
							if (file) {
								if (/^image\//i.test(file.type)) {
									$$(".img-btn").off("click");
									readFile(file);
								} else {
									alert("Not a valid image!");
									console.log("Not a valid image!");
								}
							} else {
								console.log("Not a FILE");
							}
						});
					} else {
						alert("File upload is not supported!");
						console.log("File upload is not supported!");
					}
				});
				
				$$("#create-member-btn").on("click", async function (e) {
					console.log("create-member-btn click");
					console.log(app.data.server);
					e.preventDefault();
					
					//obtiene la foto ya cortada en formato blob
					// c.result("blob").then((blob) => {console.log(blob);});
					
					username =     $$("#create-cont-name").val();
					email =        $$("#create-cont-email").val();
					mobile =       $$("#create-cont-mobile").val();
					relation =     $$("#create-cont-relation").val();
					birthday =     $$("#create-cont-birthday").val();
					
					if (!c)
					{
						app.dialog.alert('Please upload an image');
						return false;
					}
					if (!validateText(username, 'Please, enter your family member\'s desired username.', 'Your username may not have spaces before or after the text.'))
					{
						console.log("username not valid");
						return false;
					}
					if (!validateText(mobile, 'Plase, enter your family member\'s mobile phone number.', 'Your phone number may not have spaces before or after the text'))
					{
						return false;
					}
					if (!validateEmail(email))
					{
						app.dialog.alert('Please enter a valid email');
						return false;
					}
					if (!validateText(birthday, 'Plase, enter your family member\'s birthday.', 'How did you even manage to do that? No spaces before or after the text on your birthday please.'))
					{
						return false;
					}
					
					app.preloader.show("blue");
					
					app.request.promise.get(`${app.data.server}/users/?email=${email.toLowerCase()}`)
					.then(async function (res){
						if (res.data === "[]")
						{
							console.log(`result was empty\r\nCreating user\r\n${res.data}`);
							app.request.promise.postJSON(`${app.data.server}/auth/local/register`,{
								"username": username,
								"password": " ",
								"email": email,
							})
							.then(async function(res2){
								console.log(`User created successfully\r\n\r\n${res2.data}`);
								console.log(res2);
								console.log("res.data")
								console.log(res2.data);
								
								await app.request({
									url: app.data.server + '/users/' + res2.data.user.id,
									method: 'PUT',
									data: {
										"mobile": mobile,
										"birthday": birthday,
									}
								});
								c.result('blob', 'png').then(async blob =>{
									const data = new FormData();
									data.append("files", blob, 'profile.png');
									data.append("refId", res2.data.user.id);
									data.append("ref", "user");
									data.append('source', 'users-permissions');
									data.append('field', 'profilePicture');
									await app.request({
										url: app.data.server + '/upload',
										method: "POST",
										crossDomain: true,
										contentType: "multipart/form-data",
										data: data
									});
								});
								
								console.log("Inserting contact to newly created temp contact");
								// assignRelation(res2.data.user, relation, isAdmin, isMinor, editMemories);
								let assignResult = await assignRelation(loggedUser, res2.data.user, relation, false, false, false);
								app.preloader.hide();
								console.log("assignResult from temp user");
								console.log(assignResult);
								if (assignResult.result)
								{
									app.dialog.alert("Contact added successfully!, updating user");
									await app.methods.updateCurrentUser();
									// app.views.main.router.navigate({name: 'invite-admin'})
									await app.views.main.router.navigate('/memories/home');
								}
								else
								{
									app.dialog.alert("couldn't add contact! " + assignResult.message);
								}
							})
							.catch(function(err){
								console.log(`An error occurred [create-member-btn.onClick]`);
								console.log(err);
								app.preloader.hide();
								var obj = JSON.parse(err.xhr.response);
								app.dialog.alert('Some fields are incomplete or incorrect, please try again.'+'\r\n'+obj.message[0].messages[0].message);
							})
						}
						else
						{
							let user = JSON.parse(res.data)[0];
							console.log(`result wasn't empty!\r\nassigning user\r\n${user} [create-member-btn.onClick]`)
							console.log(user)
							try {
								
								console.log("Inserting contact to existing contact [create-member-btn.onClick]");
								// assignRelation(user, relation, isAdmin, isMinor, editMemories);
								let assignResult = await assignRelation(loggedUser, user, relation, false, false, false);
								app.preloader.hide();
								console.log("assignResult from existing user");
								console.log(assignResult);
								if (assignResult.result)
								{
									app.dialog.alert("Contact added successfully!");
									await app.views.main.router.navigate('/memories/home');
								}
								else
								{
									app.dialog.alert("couldn't add contact! " + assignResult.message);
								}
								
							} catch (error) {
								console.log("Error assigning contact [create-member-btn.onClick]");
								console.log(error);
								app.dialog.alert("Couldn't assign contact! " + error);
							}
						}
					})
					.catch(function (err){
						console.log("Error error");
						console.log(err);
						app.dialog.alert("Error creating or assignin the contact! " + err);
					})
				});
				
				async function assignRelation(targetUser, contactUser, contactRelation, contactIsAdmin, contactIsMinor, contactEditMemories)
				{
					console.log("user");
					console.log(contactUser);
					console.log("relation");
					console.log(contactRelation);
					console.log("isAdmin");
					console.log(contactIsAdmin);
					console.log("editMemories");
					console.log(contactEditMemories);
					console.log("isMinor");
					console.log(contactIsMinor);
					
					let result = {
						result: false,
						message: ""
					};
					await app.request.promise.get(`${app.data.server}/contacts/?owner=${targetUser.id}&contact=${contactUser.id}`)
					.then(async function(res){
						// console.log("right after get");
						// console.log(res);
						if (res.data === "[]")
						{
							// console.log('Already has contact');
							await app.request.promise.postJSON(`${app.data.server}/contacts`,{
								"relation": contactRelation,
								"owner": {
									"id": targetUser.id
								},
								"contact":{
									"id": contactUser.id
								},
								"isAdmin": contactIsAdmin,
								"isMinor": contactIsMinor,
								"editMemories": contactEditMemories
							})
							.then(function (res){
								console.log("response assignRelation");
								console.log(res);
								result.result = true;
								result.message = "Contact added successfully";
							})
							.catch(function(err){
								console.log("error addignRelation");
								console.log(err);
								result.result = false;
								result.message = err;
							})
						}
						else
						{
							// console.log('doesnt have contact');
							result.result = false;
							result.message = "You already have that user as a contact";
						}
					});
					console.log("return of assignContact")
					console.log(result);
					return result;
				}
				
				function userHasContact(user, contact)
				{
					app.request.promise.get(`${app.data.server}/contacts/?owner=${user}&contact=${contact}`)
					.then(function(res){
						console.log("right after get");
						console.log(res);
						if (res.data === "[]")
						{
							// console.log("user doesnt have contact");
							// console.log(res.data);
							return (false);
						}
						else
						{
							// console.log("user has contact");
							// console.log(res.data);
							return (true);
						}
					});
				}
				
				function validateEmail(mail) 
				{
					if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mail))
					{
						return (true);
					}
					// alert("You have entered an invalid email address!")
					return (false);
				}
				
				function validateText(text, emptyText, trimmedText, checkTrimmed = true)
				{
					console.log(`${text}, trim?: ${checkTrimmed}`);
					if (isTextEmptyOrWhitespace(text))
					{
						app.dialog.alert(emptyText);
						return false;
					}
					else
					{
						if (checkTrimmed)
						{
							if (!isTextTrimmed(text))
							{
								app.dialog.alert(trimmedText);
								return false;
							}
						}
						return true;
					}
				}
				
				function isTextValid(value)
				{
					return !isTextEmptyOrWhitespace(value) && isTextTrimmed(value);
				}
				
				function isTextEmptyOrWhitespace(value)
				{
					if (!value || !value.trim())
					{
						return true;
					}
					return false;
				}
				
				function isTextTrimmed(value)
				{
					return (value == value.trim());
				}
				
				
				//funcion para leer la foto
				function readFile(file) {
					var reader = new FileReader();
					
					reader.onloadend = function () {
						processFile(reader.result, file.type);
					};
					
					reader.onerror = function () {
						alert("There was an error reading the file!");
					};
					
					reader.readAsDataURL(file);
				}
				
				//procesar foto
				function processFile(dataURL, fileType) {
					var maxWidth = 440;
					var maxHeight = 440;
					
					var image = new Image();
					image.src = dataURL;
					
					image.onload = function () {
						var width = image.width;
						var height = image.height;
						var shouldResize = width > maxWidth || height > maxHeight;
						
						if (!shouldResize) {
							sendFile(dataURL);
							return;
						}
						
						var newWidth;
						var newHeight;
						
						if (width > height) {
							newHeight = height * (maxWidth / width);
							newWidth = maxWidth;
						} else {
							newWidth = width * (maxHeight / height);
							newHeight = maxHeight;
						}
						
						var canvas = document.createElement("canvas");
						
						canvas.width = newWidth;
						canvas.height = newHeight;
						
						var context = canvas.getContext("2d");
						
						context.drawImage(this, 0, 0, newWidth, newHeight);
						
						dataURL = canvas.toDataURL(fileType);
						
						sendFile(dataURL);
					};
					
					image.onerror = function () {
						alert("There was an error processing your file!");
					};
				}
				
				//poner foto en la pagina
				function sendFile(dataURL) {
					var imgHtml = '<img id="web-img" src="' + dataURL + '" alt="">';
					$$(".photo").html(imgHtml);
					c = new croppie(document.getElementById("web-img"), {
						viewport: {
							width: 114,
							height: 114,
							type: "circle",
						},
						boundary: {
							width: 114,
							height: 114,
						},
						showZoomer: false,
					});
				}
			},
		},
	};
</script>
<style>
	.croppie-container {
		width: 100%;
		height: 100%;
	}
	
	.croppie-container .cr-image {
		z-index: -1;
		position: absolute;
		top: 0;
		left: 0;
		transform-origin: 0 0;
		max-height: none;
		max-width: none;
	}
	
	.croppie-container .cr-boundary {
		position: relative;
		overflow: hidden;
		margin: 0 auto;
		z-index: 1;
		width: 100%;
		height: 100%;
	}
	
	.croppie-container .cr-viewport,
	.croppie-container .cr-resizer {
		position: absolute;
		border: 0px solid #fff;
		margin: auto;
		top: 0;
		bottom: 0;
		right: 0;
		left: 0;
		box-shadow: 0 0 2000px 2000px rgba(0, 0, 0, 0.5);
		z-index: 0;
	}
	
	.croppie-container .cr-resizer {
		z-index: 2;
		box-shadow: none;
		pointer-events: none;
	}
	
	.croppie-container .cr-resizer-vertical,
	.croppie-container .cr-resizer-horisontal {
		position: absolute;
		pointer-events: all;
	}
	
	.croppie-container .cr-resizer-vertical::after,
	.croppie-container .cr-resizer-horisontal::after {
		display: block;
		position: absolute;
		box-sizing: border-box;
		border: 1px solid black;
		background: #fff;
		width: 10px;
		height: 10px;
		content: "";
	}
	
	.croppie-container .cr-resizer-vertical {
		bottom: -5px;
		cursor: row-resize;
		width: 100%;
		height: 10px;
	}
	
	.croppie-container .cr-resizer-vertical::after {
		left: 50%;
		margin-left: -5px;
	}
	
	.croppie-container .cr-resizer-horisontal {
		right: -5px;
		cursor: col-resize;
		width: 10px;
		height: 100%;
	}
	
	.croppie-container .cr-resizer-horisontal::after {
		top: 50%;
		margin-top: -5px;
	}
	
	.croppie-container .cr-original-image {
		display: none;
	}
	
	.croppie-container .cr-vp-circle {
		border-radius: 50%;
	}
	
	.croppie-container .cr-overlay {
		z-index: 1;
		position: absolute;
		cursor: move;
		touch-action: none;
	}
	
	.croppie-container .cr-slider-wrap {
		width: 75%;
		margin: 15px auto;
		text-align: center;
	}
	
	.croppie-result {
		position: relative;
		overflow: hidden;
	}
	
	.croppie-result img {
		position: absolute;
	}
	
	.croppie-container .cr-image,
	.croppie-container .cr-overlay,
	.croppie-container .cr-viewport {
		-webkit-transform: translateZ(0);
		-moz-transform: translateZ(0);
		-ms-transform: translateZ(0);
		transform: translateZ(0);
	}
	/*************************************/
	/***** STYLING RANGE INPUT ***********/
	/*************************************/
	/*http://brennaobrien.com/blog/2014/05/style-input-type-range-in-every-browser.html */
	/*************************************/
	
	.cr-slider {
		-webkit-appearance: none;
		/*removes default webkit styles*/
		/*border: 1px solid white; */
		/*fix for FF unable to apply focus style bug */
		width: 300px;
		/*required for proper track sizing in FF*/
		max-width: 100%;
		padding-top: 8px;
		padding-bottom: 8px;
		background-color: transparent;
	}
	
	.cr-slider::-webkit-slider-runnable-track {
		width: 100%;
		height: 3px;
		background: rgba(0, 0, 0, 0.5);
		border: 0;
		border-radius: 3px;
	}
	
	.cr-slider::-webkit-slider-thumb {
		-webkit-appearance: none;
		border: none;
		height: 16px;
		width: 16px;
		border-radius: 50%;
		background: #ddd;
		margin-top: -6px;
	}
	
	.cr-slider:focus {
		outline: none;
	}
	
	.cr-slider::-moz-range-track {
		width: 100%;
		height: 3px;
		background: rgba(0, 0, 0, 0.5);
		border: 0;
		border-radius: 3px;
	}
	
	.cr-slider::-moz-range-thumb {
		border: none;
		height: 16px;
		width: 16px;
		border-radius: 50%;
		background: #ddd;
		margin-top: -6px;
	}
	/*hide the outline behind the border*/
	
	.cr-slider:-moz-focusring {
		outline: 1px solid white;
		outline-offset: -1px;
	}
	
	.cr-slider::-ms-track {
		width: 100%;
		height: 5px;
		background: transparent;
		/*remove bg colour from the track, we'll use ms-fill-lower and ms-fill-upper instead */
		border-color: transparent;
		/*leave room for the larger thumb to overflow with a transparent border */
		border-width: 6px 0;
		color: transparent;
		/*remove default tick marks*/
	}
	
	.cr-slider::-ms-fill-lower {
		background: rgba(0, 0, 0, 0.5);
		border-radius: 10px;
	}
	
	.cr-slider::-ms-fill-upper {
		background: rgba(0, 0, 0, 0.5);
		border-radius: 10px;
	}
	
	.cr-slider::-ms-thumb {
		border: none;
		height: 16px;
		width: 16px;
		border-radius: 50%;
		background: #ddd;
		margin-top: 1px;
	}
	
	.cr-slider:focus::-ms-fill-lower {
		background: rgba(0, 0, 0, 0.5);
	}
	
	.cr-slider:focus::-ms-fill-upper {
		background: rgba(0, 0, 0, 0.5);
	}
	/*******************************************/
	/***********************************/
	/* Rotation Tools */
	/***********************************/
	
	.cr-rotate-controls {
		position: absolute;
		bottom: 5px;
		left: 5px;
		z-index: 1;
	}
	
	.cr-rotate-controls button {
		border: 0;
		background: none;
	}
	
	.cr-rotate-controls i:before {
		display: inline-block;
		font-style: normal;
		font-weight: 900;
		font-size: 22px;
	}
	
	.cr-rotate-l i:before {
		content: "↺";
	}
	
	.cr-rotate-r i:before {
		content: "↻";
	}
</style>
