<template>
	<div class="page" id="invite-admin">
		<div class="artwork"></div>
		<div class="navbar">
			<div class="navbar-inner sliding">
				<div class="header-cont">
					<div class="header">
						<a id="invite-admin-back" href="" class="back-btn">
							<i class="icons material-icons">chevron_left</i>
						</a>
						<h1 class="title">{{localize "invite_admin"}}</h1>
						<div class="none"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="page-content">
			<div class="sqr_bck" id="sqr1"></div>
			<div class="logo-cont">
				<div class="mail">
					<div class="check">
						<img src="static/icons/check.png" alt="" />
					</div>
					<img src="static/icons/mail.png" alt="" />
				</div>
			</div>
			<div class="text-cont">
				<p class="text">
					{{localize "text_invite_admin"}}
				</p>
			</div>
			<div class="inputs list">
				<ul>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="text" id="admin-name" placeholder="{{localize 'admin_name'}}" required
									validate />
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="email" id="admin-email" placeholder="{{localize 'admin_mail'}}" required
									validate />
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="password" id="admin-password" placeholder="{{localize 'admin_password'}}"
                                    required validate />
                                    <span class="show" style="display: none;">{{localize "show"}}</span>
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="text" id="admin-relation" placeholder="{{localize 'admin_relation'}}"
									required validate />
								<a class="popup-open" href="#" data-popup=".popup-admin-relation">
									<i class="info icons material-icons">info</i>
								</a>
							</div>
						</div>
					</li>
					<li class="item-content item-input right">
						<label class="item-checkbox item-content">
							<div class="item-inner">
								<div class="item-title">{{localize "admin_edit"}}</div>
							</div>
							<input type="checkbox" id="admin-edit" name="demo-checkbox" value="admin-edit"
								checked="checked" />
							<i class="icon icon-checkbox"></i>
						</label>
					</li>
				</ul>
			</div>
			<div class="btns-cont center">
				<!-- <a id="invite-admin-btn" href="/UserAgreement" class="button color-blue round small">Invite</a> -->
				<!-- <a id="invite-admin-btn" href="/" class="button color-blue round small">Invite</a> -->
				<a id="invite-admin-btn" class="button color-blue round small">{{localize "invite"}}</a>
			</div>
			<div class="footer">
				<div class="sqr_bck" id="sqr2"></div>
				<div class="sqr_bck" id="sqr3"></div>
			</div>
		</div>
		<div class="popup popup-admin-relation">
			<div class="background">
				<div class="sqr_bck" id="sqr1"></div>
				<div class="sqr_bck" id="sqr2"></div>
			</div>
			<a class="close-btn popup-close" href="#">
				<i class="icons material-icons">close</i>
			</a>
			<h1 class="title">{{localize "which_relation"}}
			</h1>
			<p class="content">
				{{localize "which_relation_text"}}
			</p>
		</div>
	</div>
</template>
<script>
    import $$ from "dom7";
    export default {
        on: {
            pageInit: async function(e, page) {
                var self = this;
                var app = self.$app;

                var userID = app.views.main.router.currentRoute.params.userID;

                $$("#invite-admin-back").click(async function(e) {
                    // app.methods.clearCurrentUser();
                    app.views.main.router.back();
                })
                $$(".show").click(function(val) {
                    let type = $$("#admin-password").attr("type");
                    if (type == "password") {
                        $$("#admin-password").attr("type", "text");
                    } else {
                        $$("#admin-password").attr("type", "password");
                    }
                });
                $$("#admin-password").on("input:notempty", function(val) {
                    $$(".show").css("display", "block");
                    $$("#pass-edit-icon").css("display", "none");
                });
                $$("#invite-admin-btn").on('click', async function(e) {
                    //CREATE ADMIN THING

                    var adminName = $$("#admin-name").val();
                    var adminEmail = $$("#admin-email").val();
                    var adminRelation = $$("#admin-relation").val();
                    var adminPassword = $$("#admin-password").val();
                    var adminCouldEdit = $$("#admin-edit").prop('checked');

                    if (!validateText(adminName, window.localize("create_admin_name"), window.localize("create_admin_name_error"))) {
                        console.log("username not valid [pageInit.invite-admin-btn.onClick]");
                        return false;
                    }
                    if (!validateEmail(adminEmail)) {
                        app.dialog.alert(window.localize('recovery_invalid_email'));
                        return false;
                    }
                    if (!validateText(adminRelation, window.localize("create_admin_relation"), window.localize("create_admin_relation_error"), false)) {
                        return false;
                    }
                    if (!validateText(adminPassword, window.localize("create_admin_pass"), window.localize("create_admin_pass_error"), false)) {
                        return false;
                    }

                    //Admin exists?
                    app.preloader.show("blue");

                    await app.request.promise.get(`${app.data.server}/users/?email=${adminEmail.toLowerCase()}`)
                        .then(async function(adminCheckRes) {
                            if (adminCheckRes.data === "[]") {
                                //Admin account doesn't exist
                                console.log(`admin email doesn't exist, creating admin account (${adminEmail}) [pageInit.create-btn.onClick]`);
                                app.request.promise.postJSON(`${app.data.server}/auth/local/register`, {
                                        "username": adminEmail,
                                        "password": adminPassword,
                                        "email": adminEmail
                                        
                                    })
                                    .then(async function(adminAccRes) {
                                        var createdAdmin = adminAccRes.data.user;
                                        console.log("User created, adding extra data [pageInit.create-btn.onClick]");
                                        await app.request({
                                            url: app.data.server + '/users/' + createdAdmin.id,
                                            method: 'PUT',
                                            data: {
                                                "name": adminName,
                                                "created_as_receiver": true,
                                                "confirmed": true
                                            }
                                        });
                                        createdAdmin.name = adminName;
                                        console.log("Calling assignRelation [pageInit.create-btn.onClick]");
                                        //Add to contacts as admin
                                        await assignRelation(userID, createdAdmin, adminName, adminRelation, true, adminCouldEdit)
                                    })
                                    .catch(function(adminAccError) {
                                        app.preloader.hide();
                                        console.log("Error creating admin [pageInit.invite-admin-btn.onClick]");
                                        console.log(adminAccError);
                                        let adminError = JSON.parse(adminAccError.xhr.response);
                                        console.log("There was an error adding the admin [pageInit.create-btn.onClick]")
                                        console.log(adminAccError.xhr);
                                        app.dialog.alert(`There was an error adding the admin account!       \r\n${adminError.message[0].messages[0].message}`);
                                    })
                            } else {
                                //Admin account exists
                                //Add to contact as admin
                                console.log(`Admin email did exist, adding admin account (${adminEmail}) [pageInit.create-btn.onClick]`);
                                let adminUser = JSON.parse(adminCheckRes.data)[0];
                                await assignRelation(userID, adminUser, adminName, adminRelation, true, adminCouldEdit);
                            }
                        })
                    app.preloader.hide();
                    // app.dialog.alert("We've sent you an email, please confirm your account by clicking the link we've emailed you");
                    // await app.methods.clearCurrentUser();
                    // loggedUser = null;
                    await app.methods.clearCurrentUser();
                    console.log("User cleared [app.f7.signout]");
                    // await app.views.main.router.navigate('/');
                    await app.views.main.router.navigate('/');
                })

                async function assignRelation(targetUserId, contactUser, contactNickname, contactRelation, contactIsAdmin, contactEditMemories) {
                    // console.log("targetUserId [pageInit.assignRelation]");
                    // console.log(targetUserId);
                    // console.log("adminUser [pageInit.assignRelation]");
                    // console.log(contactUser);
                    // console.log("relation [pageInit.assignRelation]");
                    // console.log(contactRelation);
                    // console.log("isAdmin [pageInit.assignRelation]");
                    // console.log(contactIsAdmin);
                    // console.log("editMemories [pageInit.assignRelation]");
                    // console.log(contactEditMemories);
                    await app.request.promise.get(`${app.data.server}/contacts/?owner=${targetUserId}&contact=${contactUser.id}`).then(async function(res) {
                        if (res.data === "[]") {
                            console.log("user didn't already have a relationship with that other user");
                            await app.request.promise.postJSON(`${app.data.server}/contacts`, {
                                    "relation": contactRelation,
                                    "owner": {
                                        "id": targetUserId
                                    },
                                    "contact": {
                                        "id": contactUser.id
                                    },
                                    "isAdmin": contactIsAdmin,
                                    "isMinor": false,
                                    "editMemories": contactEditMemories,
                                    "nickname": contactNickname,
                                })
                                .then(function(assignRelRes) {
                                    console.log("response assignRelation [pageInit.assignRelation]");
                                    console.log(assignRelRes);
                                })
                                .catch(function(assignRelErr) {
                                    console.log("error assignRelation [pageInit.assignRelation]");
                                    console.log(assignRelErr);
                                })
                        } else {
                            let contactData = JSON.parse(res.data);
                            console.log("Contact relationship result: \r\n", contactData);
                            await app.request.promise({
                                url: `${app.data.server}/contacts/${contactData[0].id}`,
                                method: 'PUT',
                                data: {
                                    isAdmin: true
                                }
                            }).then(function(response) {
                                console.log("Dude added successfully!\r\n", response);
                            }).catch(function(error) {
                                console.log("An error has occurred!\r\n", error);
                            });
                            // app.dialog.alert(window.localize('create_admin_repeated'));
                        }
                    }).catch(async function(err) {
                        app.preloader.hide();
                        console.log("Error in assignContact!");
                        console.log(err);
                    });
                }

                function validateEmail(mail) {
                    if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mail)) {
                        return (true)
                    }
                    // alert("You have entered an invalid email address!")
                    return (false)
                }

                function validateText(text, emptyText, trimmedText, checkTrimmed = true) {
                    if (isTextEmptyOrWhitespace(text)) {
                        app.dialog.alert(emptyText);
                        return false;
                    } else {
                        if (checkTrimmed) {
                            if (!isTextTrimmed(text)) {
                                app.dialog.alert(trimmedText);
                                return false;
                            }
                        }
                        return true;
                    }
                }

                function isTextValid(value) {
                    return !isTextEmptyOrWhitespace(value) && isTextTrimmed(value);
                }

                function isTextEmptyOrWhitespace(value) {
                    if (!value || !value.trim()) {
                        return true;
                    }
                    return false;
                }

                function isTextTrimmed(value) {
                    return (value == value.trim());
                }

                function makeid(length) {
                    var result = '';
                    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                    var charactersLength = characters.length;
                    for (var i = 0; i < length; i++) {
                        result += characters.charAt(Math.floor(Math.random() * charactersLength));
                    }
                    return result;
                }
            },
        },
    };
</script>