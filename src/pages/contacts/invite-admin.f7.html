<template>
	<div class="page" id="invite-admin">
		<div class="artwork"></div>
		<div class="navbar">
			<div class="navbar-inner sliding">
				<div class="header-cont">
					<div class="header">
						<a href="" class="back-btn back">
							<i class="icons material-icons">chevron_left</i>
						</a>
						<h1 class="title">Invite an administrator</h1>
						<div class="none"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="page-content">
			<div class="sqr_bck" id="sqr1"></div>
			<div class="logo-cont">
				<div class="mail">
					<div class="check">
						<img src="../../static/icons/check.png" alt="" />
					</div>
					<img src="../../static/icons/mail.png" alt="" />
				</div>
			</div>
			<div class="text-cont">
				<p class="text">
					Administrador could send or edit memories for you.
				</p>
			</div>
			<div class="inputs list">
				<ul>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="text" id="admin-name" placeholder="Admin Name" required validate />
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="email" id="admin-email" placeholder="Admin Email" required validate />
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="text" id="admin-relation" placeholder="Admin relationship" required
								validate />
								<a class="popup-open" href="#" data-popup=".popup-admin-relation">
									<i class="info icons material-icons">info</i>
								</a>
							</div>
						</div>
					</li>
					<li class="item-content item-input right">
						<label class="item-checkbox item-content">
							<div class="item-inner">
								<div class="item-title">Admin could edit?</div>
							</div>
							<input type="checkbox" id="admin-edit" name="demo-checkbox" value="admin-edit"
							checked="checked" />
							<i class="icon icon-checkbox"></i>
						</label>
					</li>
				</ul>
			</div>
			<div class="btns-cont center">
				<a id="invite-admin-btn" href="/UserAgreement" class="button color-blue round small">Invite</a>
			</div>
			<div class="footer">
				<div class="sqr_bck" id="sqr2"></div>
				<div class="sqr_bck" id="sqr3"></div>
			</div>
		</div>
		<div class="popup popup-admin-relation">
			<div class="background">
				<div class="sqr_bck" id="sqr1"></div>
				<div class="sqr_bck" id="sqr2"></div>
			</div>
			<a class="close-btn popup-close" href="#">
				<i class="icons material-icons">close</i>
			</a>
			<h1 class="title">Which is your
				relationship with your
				administrator?
			</h1>
			<p class="content">
				Define your relationship with the administrator. Could be a daughter, son, wife, cousin, etc. We will
				create a contact in your account with this info.
			</p>
		</div>
	</div>
</template>
<script>
	import $$ from "dom7";
	export default {
		on: {
			pageInit: async function (e, page) { 
				var self = this;
				var app = self.$app;
				
				var userID = app.views.main.router.currentRoute.params.userID;
				
				console.log(userID);
				
				$$("#invite-admin-btn").on('click', async function(e){
					//CREATE ADMIN THING

					var adminName = $$("#admin-name").val();
					var adminEmail = $$("#admin-email").val();
					var adminRelation = $$("#admin-relation").val();
					var adminCouldEdit = $$("#admin-edit").prop('checked');

					if (!validateText(adminName, 'Please, enter your admin\'s name.', 'Your admin\'s name may not have spaces before or after the text.')) {
						console.log("username not valid [pageInit.invite-admin-btn.onClick]");
						return false;
					}
					if (!validateEmail(adminEmail)) {
						app.dialog.alert('Please enter a valid email');
						return false;
					}
					if (!validateText(adminRelation, 'Plase enter your and your admin\'s relationship.', 'Your answer may not have spaces before or after the text', false)) {
						return false;
					}

					//Admin exists?
					await app.request.promise.get(`${app.data.server}/users/?email=${adminEmail.toLowerCase()}`)
					.then(async function (adminCheckRes) {
						if (adminCheckRes.data === "[]") {
							//Admin account doesn't exist
							console.log(`admin email doesn't exist, creating admin account (${adminEmail}) [pageInit.create-btn.onClick]`);
							app.request.promise.postJSON(`${app.data.server}/auth/local/register`, {
								"username": adminName,
								"password": makeid(10),
								"email": adminEmail,
							})
							.then(function (adminAccRes) {
								//Add to contacts as admin
								assignRelation(userID, adminAccRes.data.user, adminRelation, true, adminCouldEdit)
							})
							.catch(function (adminAccError) {
								app.preloader.hide();
								console.log("Error creating admin [pageInit.invite-admin-btn.onClick]");
								console.log(adminAccError);
								let adminError = JSON.parse(adminAccError.xhr.response);
								console.log("There was an error adding the admin [pageInit.create-btn.onClick]")
								console.log(adminAccError.xhr);
								app.dialog.alert(`There was an error adding the admin account!       \r\n${adminError.message[0].messages[0].message}`);
							})
						}
						else {
							//Admin account exists
							//Add to contact as admin
							console.log(`Admin email did exist, adding admin account (${adminEmail}) [pageInit.create-btn.onClick]`);
							let adminUser = JSON.parse(adminCheckRes.data)[0];
							assignRelation(userID, adminUser, adminRelation, true, adminCouldEdit);
						}
					})
				})
				
				function assignRelation(targetUserId, contactUser, contactRelation, contactIsAdmin, contactEditMemories) {
					console.log("targetUserId [pageInit.assignRelation]");
					console.log(targetUserId);
					console.log("adminUser [pageInit.assignRelation]");
					console.log(contactUser);
					console.log("relation [pageInit.assignRelation]");
					console.log(contactRelation);
					console.log("isAdmin [pageInit.assignRelation]");
					console.log(contactIsAdmin);
					console.log("editMemories [pageInit.assignRelation]");
					console.log(contactEditMemories);
					app.request.promise.get(`${app.data.server}/contacts/?owner=${targetUserId}&contact=${contactUser.id}`)
					.then(function (res) {
						if (res.data === "[]") {
							app.request.promise.postJSON(`${app.data.server}/contacts`, {
								"relation": contactRelation,
								"owner": {
									"id": targetUserId
								},
								"contact": {
									"id": contactUser.id
								},
								"isAdmin": contactIsAdmin,
								"isMinor": false,
								"editMemories": contactEditMemories
							})
							.then(function (assignRelRes) {
								console.log("response assignRelation [pageInit.assignRelation]");
								console.log(assignRelRes);
							})
							.catch(function (assignRelErr) {
								console.log("error addignRelation [pageInit.assignRelation]");
								console.log(assignRelErr);
							})
						}
						else {
							app.dialog.alert('You already have that user as a contact!');
						}
					});
				}

				function validateEmail(mail) {
					if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mail)) {
						return (true)
					}
					// alert("You have entered an invalid email address!")
					return (false)
				}
				
				function validateText(text, emptyText, trimmedText, checkTrimmed = true) {
					if (isTextEmptyOrWhitespace(text)) {
						app.dialog.alert(emptyText);
						return false;
					}
					else {
						if (checkTrimmed) {
							if (!isTextTrimmed(text)) {
								app.dialog.alert(trimmedText);
								return false;
							}
						}
						return true;
					}
				}
				
				function isTextValid(value) {
					return !isTextEmptyOrWhitespace(value) && isTextTrimmed(value);
				}
				
				function isTextEmptyOrWhitespace(value) {
					if (!value || !value.trim()) {
						return true;
					}
					return false;
				}
				
				function isTextTrimmed(value) {
					return (value == value.trim());
				}

				function makeid(length) {
					var result = '';
					var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
					var charactersLength = characters.length;
					for (var i = 0; i < length; i++) {
						result += characters.charAt(Math.floor(Math.random() * charactersLength));
					}
					return result;
				}
			},
		},
	};
</script>