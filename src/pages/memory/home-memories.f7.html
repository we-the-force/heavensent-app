<template>
	<div class="page" id="home-memories">
		<div class="artwork"></div>
		<div class="navbar">
			<div class="navbar-inner sliding">
				<div class="header-cont">
					<div class="header">
						<a href="" class="menu-btn panel-open" data-panel=".panel-left">
							<i class="icons material-icons">menu</i>
						</a>
						<div class="title-sub">
							<h1 id="logged-user-name" class="title capitalize"></h1>
							<p id="logged-user-membership" class="subtitle capitalize">Membership</p>
						</div>
						<a href="" class="avatar-fab item-link smart-select smart-select-init" data-open-in="popover">
							<!-- llenar select con usuarios -->
							<select id="users">
								<option value="1" id="user-thing-{{LoggedUser.id}}" asd="{{LoggedUser.id}}"
									{{#js_if "this.LoggedUser.id == this.CurrentUser.id"}} selected {{/js_if}}>
									{{#js_if "this.LoggedUser.name != null"}} {{LoggedUser.name}} {{else}}
									{{LoggedUser.email}} {{/js_if}}</option>
								{{#each AdminedContacts}}
								<option value='{{js "@index + 2"}}' id="user-thing-{{id}}" asd="{{id}}"
									{{#js_if "this.id == @root.CurrentUser.id"}} selected {{/js_if}}>
									{{name}} </option>
								<!-- <option value="2" selected>Ramona</option> -->
								{{/each}}
								<!-- poner selected al usuario que esta actualmente -->
								<!-- <option value="2">Envy</option> -->
								<!-- <option value="3">Lisa</option> -->
								<!-- <option value="4">Neil</option> -->
								<!-- <option value="5">Kim</option> -->
								<!-- <option value="6">Roxy</option> -->
								<!-- <option value="7">Wallace</option> -->
							</select>
							<img id="logged-user-picture" src="" alt="">
						</a>
					</div>
				</div>
			</div>
		</div>
		<!-- agregar o quitar none de toolbar para quitarlo y ponerlo -->
		<div class="toolbar toolbar-bottom">
			<div class="toolbar-inner">
				<a class="item-link">
					<i class="icon material-icons cloud">cloud</i>
					<span class="tabbar-label">{{localize "my_memories"}}</span>
				</a>
				<a class="item-link" href="/memories/dashboard/user/{{CurrentUser.id}}">
					<div class="custom-icon">
						<i class="icon material-icons cloud grey">cloud</i>
						<i class="icon material-icons people">people</i>
					</div>
					<span class="tabbar-label two">{{localize "shared_with_me"}}</span>
				</a>
			</div>
		</div>
		<div class="page-content" id="home-memories">
			<div class="sqr_bck" id="sqr1"></div>
			<div class="sqr_bck" id="sqr2"></div>
			<div class="sqr_bck" id="sqr3"></div>
			{{#if IsEditing}}

			{{else}}
			<div class="contacts-cont">
				<div class="contacts-title">{{localize "contacts"}}</div>
				<a href="/contact/create" class="add-btn">
					<i class="icons material-icons">add</i>
				</a>
			</div>
			<div data-space-between="25" data-slides-per-view="3.3"
				class="swiper-container swiper-init contacts-swiper">
				<div class="swiper-wrapper">
					{{#each Contacts}}
					<div class="swiper-slide">
						<div class="person-cont">
							<a href="#" class="avatar-person popover-open" data-user="{{id}}"
								data-popover=".popover-person">
								{{#js_if "this.profilePicture != ''"}}
								<img src="{{@root.Server}}{{picture}}" alt="" srcset="">
								{{else}}
								<img src="" alt="" srcset="">
							</a>
							<p class="name-person">{{name}}</p>
						</div>
					</div>
					{{/each}}
				</div>
			</div>
			<div class="create-title">{{localize "create"}}</div>
			<div data-space-between="10" data-slides-per-view="1.1" class="swiper-container swiper-init create-swiper">
				<div class="swiper-wrapper">
					<div class="swiper-slide">
						<div class="card simple memory" id="new">
							<img src="../../static/img/Pluma_card.png" alt="" srcset="">
							<div class="card-content">
								<p> {{localize "new_memory"}} </p>
							</div>
						</div>
					</div>
					<div class="swiper-slide">
						<div class="card simple memory" id="birthday">
							<img src="../../static/img/Regalo_card.png" alt="" srcset="">
							<div class="card-content">
								<p> {{localize "birthday_memory"}} </p>
							</div>
						</div>
					</div>
					<div class="swiper-slide">
						<div class="card simple memory" id="colagge">
							<img src="../../static/img/sqrs.png" alt="" srcset=""
								style="margin-left: 4px; margin-top: 2px;">
							<div class="card-content">
								<p> {{localize "collage"}} </p>
							</div>
						</div>
					</div>
					<div class="swiper-slide">
						<div class="card simple memory" id="special">
							<img src="../../static/img/Pluma_card_tail.png" alt="" srcset="">
							<div class="card-content">
								<p> {{localize "especial_memory"}} </p>
							</div>
						</div>
					</div>
				</div>
			</div>
			{{/if}}
			{{#js_if "(this.Memories.pending.length + this.Memories.scheduled.length) > 0"}}
			{{#js_if "this.Memories.scheduled.length > 0"}}
			<div class="scheduled-title">{{localize "scheduled"}}</div>
			<div data-space-between="10" data-slides-per-view="1.1"
				class="swiper-container swiper-init sheduled-swiper">
				<div class="swiper-wrapper">
					{{#each Memories.scheduled}}
					<div class="swiper-slide">
						<div class="card complete v1">
							<div class="card-header">
								<div class="title-card">
									<h1>{{name}}</h1>
									<p>{{deliveryDate}}</p>
								</div>
								<a href="#" class="memory-options edit popover-open" data-popover=".popover-opt"
									data-memory="{{id}}">
									<span class="material-icons">more_horiz</span>
								</a>
							</div>
							<div class="card-content">
								{{#js_if "this.cover != ''"}}
								<div class="cover">
									<!-- <img src="../../static/img/paisaje.jpeg" alt="" srcset=""> -->
									<img src="{{@root.Server}}{{cover}}" alt="" srcset="">
								</div>
								{{else}}
								{{/js_if}}
								<img src="" alt="" srcset="">
								<div class="icons">
									<a href="#">
										<span class="material-icons">comment</span>
									</a>
									<a href="#">
										<span class="material-icons">image</span>
									</a>
									<a href="#">
										<span class="material-icons active">videocam</span>
									</a>
									<a href="#">
										<span class="material-icons">mic</span>
									</a>
									<a href="#">
										<span class="material-icons active">pin_drop</span>
									</a>
									<a href="#">
										<span class="material-icons">play_circle_filled</span>
									</a>
								</div>
							</div>
							<div class="card-footer">
								<div class="contacts">
									{{#each contacts.limitedUrls}}
									{{#js_if "this != ''"}}
									<img src="{{@root.Server}}{{this}}" alt="" class="person">
									{{else}}
									<img src="../../static/img/Busto.png" alt="" class="person">
									{{/js_if}}
									{{/each}}
									{{#js_if "this.contacts.extraContacts > 0"}}
									<div class="person plus">
										<p>+{{this.contacts.extraContacts}}</p>
									</div>
									{{/js_if}}
								</div>
							</div>
						</div>
					</div>
					{{/each}}
				</div>
			</div>
			{{/js_if}}
			{{#js_if "this.Memories.pending.length > 0"}}
			<div class="later-title">{{localize "send_later"}}</div>
			<div data-space-between="10" data-slides-per-view="1.1" class="swiper-container swiper-init later-swiper">
				<div class="swiper-wrapper">
					{{#each Memories.pending}}
					<div class="swiper-slide">
						<div class="card complete v1">
							<div class="card-header">
								<div class="title-card">
									<h1>{{name}}</h1>
									<p>{{deliveryDate}}</p>
								</div>
								<a href="#" class="memory-options edit popover-open" data-popover=".popover-opt"
									data-memory="{{id}}">
									<span class="material-icons">more_horiz</span>
								</a>
							</div>
							<div class="card-content">
								{{#js_if "this.cover != ''"}}
								<div class="cover">
									<!-- <img src="../../static/img/paisaje.jpeg" alt="" srcset=""> -->
									<img src="{{@root.Server}}{{cover}}" alt="" srcset="">
								</div>
								{{else}}
								{{/js_if}}
								<img src="" alt="" srcset="">
								<div class="icons">
									<a href="#">
										<span class="material-icons">comment</span>
									</a>
									<a href="#">
										<span class="material-icons">image</span>
									</a>
									<a href="#">
										<span class="material-icons active">videocam</span>
									</a>
									<a href="#">
										<span class="material-icons">mic</span>
									</a>
									<a href="#">
										<span class="material-icons active">pin_drop</span>
									</a>
									<a href="#">
										<span class="material-icons">play_circle_filled</span>
									</a>
								</div>
							</div>
							<div class="card-footer">
								<div class="contacts">
									{{#each contacts.limitedUrls}}
									{{#js_if "this != ''"}}
									<img src="{{@root.Server}}{{this}}" alt="" class="person">
									{{else}}
									<img src="" alt="" class="person">
									{{/js_if}}
									{{/each}}
									{{#js_if "this.contacts.extraContacts > 0"}}
									<div class="person plus">
										<p>+{{this.contacts.extraContacts}}</p>
									</div>
									{{/js_if}}
								</div>
							</div>
						</div>
					</div>
					{{/each}}
				</div>
			</div>
			{{/js_if}}
			{{else}}

			{{/js_if}}

			{{#if IsEditing}}

			{{else}}
			<div class="donate-title">{{localize "donate"}}</div>
			<div data-space-between="10" data-slides-per-view="1.1" class="swiper-container swiper-init donate-swiper">
				<div class="swiper-wrapper">
					{{#each Fundations}}
					<div class="swiper-slide">
						<div class="card card-expandable">
							<div class="card-content">
								<div class="bg-video">
									{{#js_if "this.cover != ''"}}
									<img src="{{@root.Server}}{{cover}}">
									{{else}}

									{{/js_if}}
									<div class="sqr_bck" id="sqr6"></div>
									<div class="sqr_bck" id="sqr7"></div>
									<div class="sqr_bck" id="sqr8"></div>
									<span class="material-icons play card-opened-fade-out">play_circle_outline</span>
								</div>
								<div class="card-content-padding">
									<div class="btns-cont card-opened-fade-out play-btn donation-cont" data-fundation="{{id}}">
										<!-- <a id="ckoApplePay" class="btn-card card-prevent-open" data-fundation="{{id}}">{{localize "give_now"}}</a> -->
										<a href="#" class="btn-card card-prevent-open" data-fundation="{{id}}">{{localize "give_now"}}</a>
									</div>
									<p class="card-opened-fade-in">{{desc}}</p>
								</div>
							</div>
						</div>
					</div>
					{{/each}}
				</div>
			</div>
			{{/if}}
			<div class="footer">
				<div class="sqr_bck" id="sqr4"></div>
				<div class="sqr_bck" id="sqr5"></div>
			</div>
		</div>
		<div class="popover popover-opt">
			<div class="popover-inner">
				<div class="list">
					<ul>
						<li><a id="edit-memory-btn" class="list-button item-link popover-close" href="#">{{localize "edit"}}</a></li>
						<li><a class="list-button item-link" href="#">{{localize "delete"}}</a></li>
					</ul>
				</div>
			</div>
		</div>
		<div class="popover popover-person">
			<div class="popover-inner">
				<div class="list">
					<ul>
						<li><a id="edit-contact-btn" class="list-button item-link popover-close" href="#">{{localize "edit_profile"}}</a>
						</li>
						<li><a class="list-button item-link popover-close" href="#">{{localize "create_memory"}}</a></li>
					</ul>
				</div>
			</div>
		</div>
	</div>
</template>
<script>
	import $$ from "dom7";
	import localforage from "localforage";
	export default {
		on: {
			pageInit: async function (e, page) {
				var self = this;
				var app = self.$app;
				var isEditing = page.route.context.IsEditing;
				var currentUser = page.route.context.CurrentUser;
				var fundations = page.route.context.Fundations;
				var paymentToken;
				// console.log("home-memories pageInit [pageInit], updating user");

				console.log("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAH");
				console.log(app.device);
				app.dialog.alert(app.device.os + ", ver 0.0.2.15");

				await app.methods.updateCurrentUser();
				await app.methods.loadContacts();

				var loggedUser = await app.methods.getLocalValue('loggedUser');

				if (loggedUser == null) {
					app.dialog.alert("There was a problem getting your account, please contact support about this issue.");
					app.views.main.router.navigate('/');
				}

				await updateControls();
				if (isOverflown($$('.header h1.title')[0])) {
					$$('.header h1.title').css('font-size', '18px');
				}

				

					console.log("---------------------------------Not ios");
					const baseRequest = {
					apiVersion: 2,
					apiVersionMinor: 0
					};

					const allowedCardNetworks = ["AMEX", "DISCOVER", "INTERAC", "JCB", "MASTERCARD", "VISA"];
					const allowedCardAuthMethods = ["PAN_ONLY", "CRYPTOGRAM_3DS"];

					const tokenizationSpecification = {
						type: 'PAYMENT_GATEWAY',
						parameters: {
								'gateway': 'example',
								'gatewayMerchantId': 'exampleGatewayMerchantId'
						}
					};

					const baseCardPaymentMethod = {
						type: 'CARD',
						parameters: {
								allowedAuthMethods: allowedCardAuthMethods,
								allowedCardNetworks: allowedCardNetworks
						}
					};

					const cardPaymentMethod = Object.assign(
						{},
						baseCardPaymentMethod,
						{
								tokenizationSpecification: tokenizationSpecification
						}
					);
					
					let paymentsClient = null;

					function getGoogleIsReadyToPayRequest() {
						return Object.assign(
										{},
										baseRequest,
										{
												allowedPaymentMethods: [baseCardPaymentMethod]
										}
						);
					}

					function getGooglePaymentDataRequest() {
						const paymentDataRequest = Object.assign({}, baseRequest);
						paymentDataRequest.allowedPaymentMethods = [cardPaymentMethod];
						paymentDataRequest.transactionInfo = getGoogleTransactionInfo();
						paymentDataRequest.merchantInfo = {
								// @todo a merchant ID is available for a production environment after approval by Google
								// See {@link https://developers.google.com/pay/api/web/guides/test-and-deploy/integration-checklist|Integration checklist}
								merchantId: '247883957',
								merchantName: 'HeavenSent'
						};
						return paymentDataRequest;
					}
				
					function getGooglePaymentsClient() {
						if ( paymentsClient === null ) {
								paymentsClient = new google.payments.api.PaymentsClient({environment: 'TEST'});
						}
						return paymentsClient;
					}

					// function onGooglePayLoaded() {
					// 	const paymentsClient = getGooglePaymentsClient();
					// 	paymentsClient.isReadyToPay(getGoogleIsReadyToPayRequest())
					// 					.then(function(response) {
					// 							if (response.result) {
					// 									addGooglePayButton();
					// 									// @todo prefetch payment data to improve performance after confirming site functionality
					// 									// prefetchGooglePaymentData();
					// 							}
					// 					})
					// 					.catch(function(err) {
					// 							// show error in developer console for debugging
					// 							console.error(err);
					// 					});
					// }
					
					function addGooglePayButton(buttonId) {

						const paymentsClient = getGooglePaymentsClient();
						var i;
						var donationThings = document.getElementsByClassName("donation-cont");
						for (i = 0; i < donationThings.length; i++)
						{
							let currentId = $$(donationThings[i]).prop("dataset").fundation;

							const button = paymentsClient.createButton({onClick: onGooglePaymentButtonClicked});
							console.log(button);
							// const button = paymentsClient.createButton({onClick: testDonate});
							$$(button).find('.gpay-button').attr('data-fundation', currentId);
							$$(button).find('.gpay-button').addClass('card-prevent-open');
							//btn-card card-prevent-open

							donationThings[i].appendChild(button);
						}
						// document.getElementById('btn-cont').appendChild(button);
					}
					function getGoogleTransactionInfo(amount) {
						let aux = {
								countryCode: 'US',
								currencyCode: 'USD',
								totalPriceStatus: 'FINAL',
								// set to cart total
								// totalPrice: selectedPlan != undefined ? selectedPlan.cost.toString() : '5.00'
								totalPrice: amount != undefined ? amount.toString() : '0.00'
						};
						return aux;
					}

					function prefetchGooglePaymentData() {
						const paymentDataRequest = getGooglePaymentDataRequest();
						// transactionInfo must be set but does not affect cache
						paymentDataRequest.transactionInfo = {
								totalPriceStatus: 'NOT_CURRENTLY_KNOWN',
								currencyCode: 'USD'
						};
						const paymentsClient = getGooglePaymentsClient();
						paymentsClient.prefetchPaymentData(paymentDataRequest);
					}

					function onGooglePaymentButtonClicked() {
						let fundationId = $$(this).prop("dataset").fundation;
						let fund = getFundation(fundationId);

						const paymentDataRequest = getGooglePaymentDataRequest();
						paymentDataRequest.transactionInfo = getGoogleTransactionInfo(fund.suggestedAmount);

						const paymentsClient = getGooglePaymentsClient();
						paymentsClient.loadPaymentData(paymentDataRequest)
										.then(function(paymentData) {
												// handle the response
												processPayment(paymentData);
												donate(fund);
												// assignPlan(paymentData);
										})
										.catch(function(err) {
												// show error in developer console for debugging
												console.error(err);
										});
					}

					function processPayment(paymentData) {
						// show returned data in developer console for debugging
								console.log(paymentData);
						// @todo pass payment token to your gateway to process payment
						paymentToken = paymentData.paymentMethodData.tokenizationData.token;
					}

					// app.methods.loadscript('https://pay.google.com/gp/p/js/pay.js', function(){
					// 	const paymentsClient = getGooglePaymentsClient();
					// 	paymentsClient.isReadyToPay(getGoogleIsReadyToPayRequest())
					// 					.then(function(response) {
					// 							if (response.result) {
					// 									addGooglePayButton();
					// 									// @todo prefetch payment data to improve performance after confirming site functionality
					// 									// prefetchGooglePaymentData();
					// 							}
					// 					})
					// 					.catch(function(err) {
					// 							// show error in developer console for debugging
					// 							console.error(err);
					// 					});
					// } )

				function getFundation(id)
				{
					let result = undefined;
					fundations.forEach(fund => {
						if (fund.id == id)
						{
							result = fund;
						}
					});
					return result;
				}
				function formatConcept(fund)
				{
					let result = `Donation towards ${fund.name}`;
					return result;
				}
				function formatDate()
				{
					let date = new Date();
					let dd = String(date.getDate()).padStart(2, '0');
					let mm = String(date.getMonth() + 1).padStart(2, '0');
					let yyyy = date.getFullYear();

					let result = `${yyyy}-${mm}-${dd}`;

					return result;
				}

				/* aqui esta este pedo */

				$$('select#users').change(async function (el) {
					let select = app.smartSelect.get('.smart-select');
					let indexValue = select.getValue();
					let indexValueTwo = $$(this)[0].value;
					let id = $$(this)[0][indexValueTwo - 1].id;
					let targetUserId = $$(`#${id}`).attr("asd");

					console.log(`Index Value Two: ${indexValueTwo}, ${id}`);

					let item = select.items[indexValue - 1];

					select.close();

					await app.views.main.router.navigate(`/memories/home/user/${targetUserId}`, { reloadCurrent: true });
					// app.views.main.router.refreshPage();
				});

				$$('.avatar-person').on('click', function (val) {
					// console.log($$(this).prop("dataset").user);
					$$('#edit-contact-btn')[0].href = "/contact/edit/contact/" + $$(this).prop("dataset").user;
					// console.log($$('.popover-person'));
				})

				$$('.memory-options').on('click', function (val) {
					$$('#edit-memory-btn')[0].href = "/memories/edit/memory/" + $$(this).prop("dataset").memory;
				})

				$$('.card.memory').click(function (val) {
					// console.log($$(this).attr('id'));
					switch ($$(this).attr('id')) {
						case 'new':
							app.views.main.router.navigate('/memories/create');
							break;
						case 'birthday':
							app.views.main.router.navigate('/memories/birthday');
							break;
						case 'colagge':
							break;
						case 'special':
							break;
					}
				});

				$$('.card-expandable').on('card:open', x => {
					let swiper = app.swiper.get('.donate-swiper');
					swiper.allowTouchMove = false;
				});

				$$('.card-expandable').on('card:close', x => {
					let swiper = app.swiper.get('.donate-swiper');
					swiper.allowTouchMove = true;
				});

				$$('.card-expandable .btn-card').click(x => {
					console.log('make somthing');

				});

				function updateControls() {
					if (currentUser != null) {
						var currentMembership = currentUser.currentMembership;
						if (currentMembership === null) {
							if (window.language == 'en_US') {
								currentMembership = 'No ' + window.localize('membership');
							} else if (window.language == 'es_MX') {
								currentMembership = 'Sin ' + window.localize('membership');
							}
						}
						else {
							if (window.language == 'en_US') {
								currentMembership = loggedUser.currentMembership.plan.name + " " + window.localize('membership');
							} else if (window.language == 'es_MX') {
								currentMembership = window.localize('membership') + " " + loggedUser.currentMembership.plan.name;
							}
						}

						$$("#logged-user-name")[0].textContent = isEditing ? (currentUser.name != undefined ? `Managing ${currentUser.name}'s memories` : `Managing ${currentUser.username}'s memories`) : currentUser.name != undefined ? currentUser.name : currentUser.username;
						$$("#logged-user-membership")[0].textContent = currentMembership;
						if (currentUser.profilePicture != null) {
							$$("#logged-user-picture")[0].src = `${app.data.server}${currentUser.profilePicture.url}`;
						}
					}
					else {
						console.log("User was null, not updating anything [pageInit.updateControls]");
					}
				}

				function isOverflown(element) {
					return element.scrollHeight > element.clientHeight || element.scrollWidth > element.clientWidth;
				}

				async function donate(fund)
				{
					if (fund != undefined)
					{
						await app.request.promise.postJSON(`${app.data.server}/donations`,{
							"amountUSD": fund.suggestedAmount,
							"fundation": fund.id,
							"user": loggedUser.id,
							"date": formatDate(),
							"token": paymentToken != undefined ? paymentToken : "EmptyTokenHopefullyATest",
							"concept": formatConcept(fund)
						}).then(function(res){
							console.log("Donation done successfully");
							app.dialog.alert("Thank you so much for your donation!");
						}).catch(function(err){
							console.log("Error adding donation");
							console.log(err);
						})
					}
					else
					{
						console.log("fundation was undefined lmao");
					}
				}

				async function testDonate()
				{
					let fundationId = $$(this).prop("dataset").fundation;
					let fund = getFundation(fundationId);
					if (fund != undefined)
					{
						await app.request.promise.postJSON(`${app.data.server}/donations`,{
							"amountUSD": fund.suggestedAmount,
							"fundation": fund.id,
							"user": loggedUser.id,
							"date": formatDate(),
							"token": paymentToken != undefined ? paymentToken : "EmptyTokenHopefullyATest",
							"concept": formatConcept(fund)
						}).then(function(res){
							app.dialog.alert("Thank you so much for your donation!");
						}).catch(function(err){
							console.log("Error adding donation");
							console.log(err);
						})
					}
					else
					{
						console.log("fundation was undefined lmao");
					}
				}
			},
		},
	};
</script>