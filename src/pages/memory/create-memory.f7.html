<template>
    <div class="page" data-name="create-memory" id="create-memory">
        <div class="artwork"></div>
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="header-cont">
                    <div class="header">
                        <a class="back-btn">
                            <i class="icons material-icons">chevron_left</i>
                        </a>
                        <h1 class="title">Create Memory</h1>
                        <div class="none"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="page-content">
            <div class="inputs list" id="_01">
                <ul>
                    <li class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-input-wrap">
                                <input type="text" id="title" placeholder="Title" required validate>
                            </div>
                        </div>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-input-wrap textarea">
                                <textarea id="description" placeholder="Description" class="resizable"
                                maxlength="140"></textarea>
                                <span class="contador">0/140</span>
                            </div>
                        </div>
                    </li>
                    <!-- <li class="item-content item-input with-label">
                        <label for="notes" class="note-title">Note</label>
                        <div class="item-inner">
                            <div class="item-input-wrap textarea">
                                <textarea id="notes" placeholder="Text" class="resizable" maxlength="140"></textarea>
                                <span class="contador">0/140</span>
                            </div>
                        </div>
                    </li> -->
                </ul>
            </div>
            <!-- <div class="btns-cont center" id="b_01">
                <a id="add-note-btn" class="button color-blue round large">Add note</a>
            </div> -->
            <div class="upload-title">Upload files</div>
            <div class="upload-cont">
                
                <div class="progress-cont">
                    <p class="bar"><span data-progress="0" class="progressbar" id="space-progressbar"></span></p>
                    <div class="desc">Available space <div id="prog">100</div>MB out of <div id="total">100</div>MB
                </div>
            </div>
            <div class="media-cont">
                <label class="cover" for="add-cover">
                    <img src="" alt="">
                    <a class="edit popover-open" data-popover=".popover-opt">
                        <span class="material-icons">more_horiz</span>
                    </a>
                    <input type="file" id="add-cover" class="none" accept="image/*">
                </label>
                <div class="medias">
                    <div class="media">
                        <span class="material-icons">mic</span>
                    </div>
                    <div class="media">
                        <span class="material-icons">comment</span>
                    </div>
                    <div class="media">
                        <span class="material-icons">image</span>
                    </div>
                    <div class="media">
                        <span class="material-icons">videocam</span>
                    </div>
                </div>
            </div>
            <div class="btns-cont center add" id="b_02">
                <label id="add-media" href="" class="add-btn">
                    <i class="icons material-icons">add</i>
                    <input type="file" id="file-inp" class="none" accept="video/*,image/*">
                </label>
            </div>
        </div>
        <div class="contacts-title">Add contacts
        </div>
        <div class="contacts-cont">
            <div class="contacts">
                <div class="person no_contact">
                    <!-- cuando no hay contactos agregados quitar la clase none -->
                </div>
                <!-- <div class="person">
                    <span class="material-icons close">close</span>
                    <img src="../../static/img/envy.jpg" alt="">
                </div>
                <div class="person">
                    <span class="material-icons close">close</span>
                    <img src="../../static/img/ramona.jpeg" alt="">
                </div>
                <div class="person">
                    <span class="material-icons close">close</span>
                    <img src="../../static/img/scott.jpeg" alt="">
                </div>
                <div class="person">
                    <span class="material-icons close">close</span>
                    <img src="../../static/img/kim.jpeg" alt="">
                </div> -->
            </div>
            <div class="btns-cont center add" id="b_03">
                <a id="add-contact" href="/memories/contacts" class="add-btn">
                    <i class="icons material-icons">add</i>
                </a>
            </div>
        </div>
        <div class="location-title">Location
        </div>
        <div class="location-cont">
            <div class="btns-cont center location-btn" id="b_04">
                <a id="add-location-btn" href="/memories/location" class="button color-blue round large">Add
                    location</a>
                </div>
                <div class="location-map none">
                    <div class="map" id="map-static"></div>
                    <div class="map-info">
                        <div class="address">
                            <h1 class="title">Address</h1>
                            <p class="addr">6th Ave 1274b</p>
                        </div>
                        <a href="/memories/location" class="edit-btn addr">
                            <i class="icons material-icons">edit</i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="date-title">Deliver date
                <!-- quitar none cuando este moestrando informacion o agregar none cuando no haya info -->
                <a href="" class="edit-btn deliver popup-open none" data-popup=".popup-deliver">
                    <i class="icons material-icons">edit</i>
                </a>
            </div>
            <!-- aggrega la clase none alboton cuando se vaya a mostrar informacion y quitar none de el div deliver info -->
            <div class="deliver-cont">
                <div class="btns-cont center date-btn" id="b_05">
                    <a id="add-deliver-date" class="button color-blue round large popup-open"
                    data-popup=".popup-deliver">Set date to deliver</a>
                </div>
                <div class="deliver-info none">
                    <div class="info-cont">
                        <div class="date-info">
                            <p class="title">Date:</p>
                            <p class="val">09/22/2020</p>
                        </div>
                        <div class="time-info">
                            <p class="title">Time:</p>
                            <p class="val">07:15</p>
                        </div>
                    </div>
                    <div class="footer-deliver">The memory will repeat itself every year until 08/22/2024</div>
                </div>
            </div>
            <div class="ondemand-cont">
                <div class="ondemand">
                    <h1>On Demand</h1>
                    <a class="popup-open" href="#" data-popup=".popup-demand">
                        <i class="info icons material-icons">info</i>
                    </a>
                </div>
                <label class="toggle toggle-init" id="on-demand-toggle">
                    <input type="checkbox">
                    <span class="toggle-icon"></span>
                </label>
            </div>
            <div class="btns-cont center create" id="b_04">
                <a id="create-btn-memory" class="button color-white round large">Create memory</a>
            </div>
        </div>
        <div class="popup popup-demand">
            <div class="block">
                <p>The user can access the content as many times as they can and wherever</p>
            </div>
        </div>
        <div class="popup popup-deliver">
            <div class="immediately-cont">
                <h1>Send immediately</h1>
                <label class="toggle toggle-init" id="immediately-toggle">
                    <input id="send-immediately-toggle" type="checkbox">
                    <span class="toggle-icon"></span>
                </label>
            </div>
            
            <div class="inputs list">
                <ul>
                    <li class="item-content item-input two-inputs">
                        <div class="item-inner">
                            <label for="deliver-date" class="label">Date</label>
                            <div class="item-input-wrap">
                                <input type="date" class="pop-deliver-inputs" id="deliver-date" required validate />
                            </div>
                        </div>
                        <div class="item-inner">
                            <label for="deliver-date" class="label">Time</label>
                            <div class="item-input-wrap">
                                <input type="time" class="pop-deliver-inputs" id="deliver-time" required validate />
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            
            <div class="repeat-cont">
                <h1>Repeat</h1>
                <div class="inputs list">
                    <ul>
                        <li class="item-content item-input two-inputs">
                            <div class="item-inner">
                                <div class="item-input-wrap">
                                    <a id="select-repeat" class="select color-white round small popover-open"
                                    data-popover=".popover-repeat">
                                    <i class="material-icons">keyboard_arrow_down</i>
                                    <p> Every Year</p>
                                </a>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        <div class="end-repeat-cont">
            <h1>End repetition</h1>
            <div class="inputs list">
                <ul>
                    <li class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-input-wrap">
                                <input type="date" id="date-end" class="pop-deliver-inputs" required validate />
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        <div class="footer">The memory will repeat itself every year until <div>--/--/----</div>
    </div>
    <div class="btns-cont center" id="date">
        <a id="accept-deliver-date" class="button color-blue grey round small" disabled="true">Accept</a>
    </div>
</div>
<div class="popover popover-repeat">
    <div class="popover-inner">
        <div class="list">
            <ul>
                <li><a class="list-btn never popover-close" href="#">Never</a></li>
                <li><a class="list-btn every_day popover-close" href="#">Every day</a></li>
                <li><a class="list-btn weekly popover-close" href="#">Weekly</a></li>
                <li><a class="list-btn biweekly popover-close" href="#">Biweekly</a></li>
                <li><a class="list-btn each_month popover-close" href="#">Each month </a></li>
                <li><a class="list-btn every_3_months popover-close" href="#">Every 3 months</a></li>
                <li><a class="list-btn every_6_months popover-close" href="#">Every 6 months</a></li>
                <li><a class="list-btn every_year popover-close checked" href="#">Every year</a></li>
            </ul>
        </div>
    </div>
</div>
<div class="popover popover-opt space-on-left">
    <div class="popover-angle none"></div>
    <div class="popover-inner">
        <div class="list">
            <ul>
                <li>
                    <label for="file-cover">
                        <i class="list-button item-link popover-close" href="#" id="edit">Edit</i>
                        <input type="file" id="file-cover" class="none" accept="image/*">
                    </label>
                </li>
                <li><a class="list-button item-link popover-close" href="#" id="delete">Delete</a></li>
            </ul>
        </div>
    </div>
</div>
</div>
</template>
<script>
    // var app = new Framework7();
    import $$ from "dom7";
    export default {
        on: {
            pageInit: async function (e, page) {
                var self = this;
                var app = self.$app;

                var loggedUser = await app.methods.getLocalValue('loggedUser');

                
                var latlng = sessionStorage.latlng;
                var addr = sessionStorage.addr;
                var title = sessionStorage.title;
                var desc = sessionStorage.desc;
                var immediately = sessionStorage.immediately;
                var date = sessionStorage.date;
                var time = sessionStorage.time;
                var repeat = sessionStorage.repeat;
                var date_end = sessionStorage.date_end;
                var footer = sessionStorage.footer;
                var on_demand = sessionStorage.on_demand;
                
                var files = [];
                var mb = 0;
                var cover /* = sessionStorage.cover */;
                var contacts = sessionStorage.contacts;
                var maxmb = page.route.context.CurrentPlan.plan.memoryQuotaMB;
                var maxbytes = maxmb * 1000000;
                var plan = page.route.context.CurrentPlan.plan.name;
                var toggle_immediately = app.toggle.create({
                    el: '#immediately-toggle'
                });
                var toggle_demand = app.toggle.create({
                    el: '#on-demand-toggle'
                });
                sessionStorage.on_demand = JSON.stringify(toggle_demand.checked);
                
                $$('.progress-cont .desc').find('#total').text(maxmb);
                $$('.progress-cont .desc').find('#prog').text(maxmb);
                
                switch (plan) {
                    case "basic":
                    $$('.location-cont #add-location-btn').removeAttr('href');
                    $$('.location-cont').addClass('none');
                    $$('.location-title').addClass('none');
                    $$('.ondemand-cont').addClass('none');
                    $$('.media-cont #add-media input').attr("accept", "image/*");
                    break;
                    case "standard":
                    $$('.location-cont #add-location-btn').removeAttr('href');
                    $$('.location-cont').addClass('none');
                    $$('.location-title').addClass('none');
                    $$('.ondemand-cont').addClass('none');
                    break;
                    case "premium":
                    
                    break;
                    default:
                    break;
                }
                /* si hay un cover guardado lo coloca */
                /* if (cover && cover != 'null') {
                    cover = new Image();
                    cover.src = JSON.parse(sessionStorage.cover);
                    mb = JSON.parse(sessionStorage.mb);
                    $$('.media-cont .cover img').attr('src', cover.src);
                    $$('.media-cont .cover img').parent().addClass('edit');
                    progressBar(mb)
                } */
                
                if (latlng && addr) {
                    latlng = JSON.parse(latlng);
                    addr = JSON.parse(addr);
                    $$('.location-cont .location-btn').addClass('none');
                    $$('.location-cont .location-map').removeClass('none');
                    $$('.location-cont .map-info .address .addr').text(addr);
                    let marker = $$('<div class="centerMarker"></div>');
                    var map_2 = new google.maps.Map(document.getElementById("map-static"), {
                        zoom: 14,
                        center: latlng,
                        disableDefaultUI: true,
                        gestureHandling: 'none'
                    });
                    marker.addClass('centerMarker').appendTo(map_2.getDiv());
                }
                if (on_demand) {
                    toggle_demand.checked = JSON.parse(on_demand);
                }
                if (title) {
                    $$('input#title').val(JSON.parse(title));
                }
                if (desc) {
                    $$('textarea#description').val(JSON.parse(desc));
                }
                
                if (date && time && repeat) {
                    $$('.date-title .edit-btn').removeClass('none');
                    $$('.deliver-cont .btns-cont').addClass('none');
                    $$('.deliver-cont .deliver-info').removeClass('none');
                    toggle_immediately.checked = JSON.parse(sessionStorage.immediately);
                    $$('#deliver-date').val(JSON.parse(sessionStorage.date));
                    $$('#deliver-time').val(JSON.parse(sessionStorage.time));
                    $$('#select-repeat p').text(JSON.parse(sessionStorage.repeat))
                    if (JSON.parse(sessionStorage.date_end) != "") {
                        $$('#date-end').val(JSON.parse(sessionStorage.date_end))
                    } else {
                        /* disable and grey */
                        $$('#date-end.pop-deliver-inputs').addClass('grey');
                        $$('#date-end.pop-deliver-inputs').prop("disabled", true);
                    }
                    $$('.deliver-cont .deliver-info .footer-deliver').text(JSON.parse(sessionStorage.footer));
                    $$('.deliver-cont .deliver-info .date-info .val').text(JSON.parse(sessionStorage.date));
                    $$('.deliver-cont .deliver-info .time-info .val').text(JSON.parse(sessionStorage.time));
                }
                
                /* si hay contactos guardados los coloca */
                
                if (contacts) {
                    contacts = JSON.parse(contacts);
                    $$('.contacts-cont .contacts .person.contact').remove();
                    contacts.length > 0 ? $$('.contacts-cont .contacts .person.no_contact').addClass('none') : $$('.contacts-cont .contacts .person.no_contact').removeClass('none');
                    contacts.forEach(el => {
                        let contact = $$('<div class="person contact" data-id="' + el.id + '">' +
                            '<span class="material-icons close">close</span>' +
                            '<img src="' + el.img + '" alt="">' +
                            '</div>')
                            contact.appendTo($$('.contacts-cont .contacts'));
                        });
                    }
                    if (sessionStorage.date && sessionStorage.time && sessionStorage.repeat) {
                        $$('#accept-deliver-date').prop('disabled', false);
                        $$('#accept-deliver-date').removeClass('grey');
                        $$('#accept-deliver-date').addClass('popup-close');
                        $$('#accept-deliver-date').off('click').click(x => deliverAccept());
                    }
                    
                    /* habilita deshabilita end repetition dependiendo de lo que selecciones en repeat */
                    $$('.popover-repeat .popover-close').click(function (el) {
                        let input_end = $$('#date-end.pop-deliver-inputs');
                        $$(this).parent().parent().find('.checked').removeClass('checked');
                        $$(this).addClass('checked');
                        $$('.popup-deliver .select p').text($$(this).text());
                        
                        if ($$(this).hasClass('never')) {
                            input_end.addClass('grey');
                            input_end.prop("disabled", true);
                            $$('.pop-deliver-inputs').trigger('change');
                            $$('.popup-deliver .footer').text('The memory will never repeat');
                        } else {
                            input_end.removeClass('grey');
                            input_end.prop("disabled", false);
                            $$('.pop-deliver-inputs').trigger('change');
                            $$('.popup-deliver .footer').html('The memory will repeat itself ' + $$(this).text() + ' until <div>--/--/----</div>');
                        }
                    })
                    
                    /* cuenta palabras de los text area */
                    $$('textarea').on('input:notempty', function (val) {
                        $$(this).next().text($$(this).val().length + '/140');
                    });
                    $$('textarea').on('input:empty', function (val) {
                        $$(this).next().text('0/140');
                    });
                    
                    /* verifica que los inputs necesarios esten llenos en el popover */
                    $$('.pop-deliver-inputs').change(function (e) {
                        console.log("Some shit changed");
                        var inputs = $$('.pop-deliver-inputs:not(.grey)');
                        console.log(inputs);
                        var nonempty = inputs.filter(function () {
                            return this.value != ''
                        });
                        if (nonempty.length == inputs.length) {
                            $$('#accept-deliver-date').prop('disabled', false);
                            $$('#accept-deliver-date').removeClass('grey');
                            $$('#accept-deliver-date').addClass('popup-close');
                            $$('#accept-deliver-date').off('click').click(x => deliverAccept());
                        } else {
                            $$('#accept-deliver-date').prop('disabled', true);
                            $$('#accept-deliver-date').addClass('grey');
                            $$('#accept-deliver-date').removeClass('popup-close');
                        }
                    });
                    
                    /* agrega fecha en el footer */
                    $$('.pop-deliver-inputs#date-end').change(function (e) {
                        $$('.popup-deliver .footer').children('div').text($$(this).val());
                    });
                    
                    /* guarda el valor del toggle cuando cambia */
                    $$('#on-demand-toggle').on('toggle:change', function (val) {
                        sessionStorage.on_demand = JSON.stringify(app.toggle.get(this).checked);
                    });
                    
                    /* guarda el valor del  titulo por si cambia la pantalla*/
                    $$('input#title').on('input:notempty', function (params) {
                        sessionStorage.title = JSON.stringify($$(this).val());
                    });
                    
                    /* guarda los valores de la descripcion si cambia de pantalla */
                    $$('textarea#description').on('input:notempty', function (params) {
                        sessionStorage.desc = JSON.stringify($$(this).val());
                    });
                    
                    /* elimina un contacto */
                    $$('.person.contact .close').click(function (val) {
                        contacts.splice(contacts.indexOf(contacts.find(x => x.id == $$(this).parent().data('id'))), 1);
                        sessionStorage.contacts = JSON.stringify(contacts);
                        $$(this).parent().remove();
                        if (contacts.length == 0) $$('.contacts-cont .contacts .person.no_contact').removeClass('none');
                    });
                    
                    /* delete cover img */
                    $$('.popover-opt .list-button#delete').click(function (val) {
                        let cover_cont = $$('.media-cont .cover');
                        mb -= cover.size;
                        progressBar(mb)
                        cover = null;
                        cover_cont.children('img').attr('src', '');
                        cover_cont.removeClass('edit');
                        $$('#add-cover').off('click');
                        /* coverSessionstorage(cover); */
                    });
                    
                    /* change cover img */
                    $$('#file-cover').change(function (val) {
                        let reader = new FileReader();
                        let cover_cont = $$('.media-cont .cover');
                        if (this.files && this.files[0]) {
                            reader.onload = e => {
                                cover_cont.addClass('edit');
                                cover_cont.children('img').attr('src', e.target.result);
                                /* coverSessionstorage(e.target.result); */
                            }
                            let newmb = mb - cover.size;
                            if ((newmb + this.files[0].size) <= maxbytes) {
                                reader.readAsDataURL(this.files[0]);
                                mb -= cover.size;
                                cover = this.files[0];
                                mb += cover.size;
                                progressBar(mb);
                            } else {
                                console.log("file-cover.change. newmb thing");
                                console.log(newmb);
                                app.dialog.alert('No space available');
                                
                            }
                        }
                    });
                    
                    /* add cover img */
                    $$('#add-cover').change(function (val) {
                        let reader = new FileReader();
                        let cover_cont = $$('.media-cont .cover');
                        if (this.files && this.files[0]) {
                            reader.onload = e => {
                                cover_cont.addClass('edit');
                                cover_cont.children('img').attr('src', e.target.result);
                                /* coverSessionstorage(e.target.result); */
                            }
                            if ((mb + this.files[0].size) <= maxbytes) {
                                reader.readAsDataURL(this.files[0]);
                                cover = this.files[0];
                                mb += cover.size;
                                progressBar(mb);
                            } else {
                                console.log("add-cover.change. mb thing");
                                console.log(mb);
                                console.log(this.files[0].size);
                                console.log("total");
                                console.log(mb + this.files[0].size);
                                console.log(`${mb} + ${this.files[0].size} = ${mb + this.files[0].size}, total size <= ${maxbytes}? ${((mb + this.files[0].size) <= maxbytes)}`);
                                app.dialog.alert('No space available');
                            }
                        }
                        $$(this).on('click', function (event) {
                            event.preventDefault();
                        });
                    });
                    
                    /* add file */
                    $$('#file-inp').change(async function (val) {
                        let reader = new FileReader();
                        let medias = $$('.media-cont .medias');
                        let newfile = $$('<div class="media fill">' +
                            '<span class="material-icons close">close</span>' +
                            '<img src="" alt="">' +
                            '</div>');
                            if (this.files && this.files[0]) {
                                /* si hay archivos */
                                reader.onload = e => {
                                    if (!medias.find('.media:last-child').hasClass('fill')) {
                                        /* si no hay nada agrega unas clases */
                                        medias.find('.media').addClass('none');
                                        medias.addClass('f_start');
                                    }
                                    /* funcion que ejecuta cuando lee el archivo */
                                    newfile.children('img').attr('src', e.target.result);
                                    newfile.appendTo(medias);
                                    
                                    $$('.media-cont .media.fill .close').off('click');
                                    $$('.media-cont .media.fill .close').click(function (val) {
                                        /* 
                                        cuando eliminas un archivo 
                                        lo borra del array
                                        baja la barra de progreso
                                        elimina el html
                                        */
                                        mb -= files[$$(this).parent().index() - 4].size;
                                        progressBar(mb)
                                        files.splice($$(this).parent().index() - 4, 1);
                                        $$(this).parent().remove();
                                        if (!medias.find('.media:last-child').hasClass('fill')) {
                                            /* cuando no hay archivos regresa al estado original */
                                            medias.find('.media').removeClass('none');
                                            medias.removeClass('f_start');
                                        }
                                    });
                                }
                                if ((mb + this.files[0].size) <= maxbytes) {
                                    /* 
                                    si no pasa el maximo de tamaÃ±o
                                    lee el archivo
                                    agrega al array
                                    aumenta la barra de progreso
                                    */
                                    reader.readAsDataURL(this.files[0]);
                                    files.push(this.files[0]);
                                    mb += this.files[0].size;
                                    progressBar(mb);
                                } else {
                                    app.dialog.alert('No space available');
                                }
                            }
                        });
                        
                        $$('.back-btn').click(e => {
                            sessionStorage.clear();
                            app.views.main.router.navigate('/memories/home');
                        });
                        
                        /* aqui guarda la memoria */
                        $$('#create-btn-memory').click(async e => {
                            let ss = sessionStorage;
                            
                            let immediately = $$("#send-immediately-toggle").prop("checked");
                            let date = $$("#deliver-date").val();
                            console.log(immediately);
                            
                            let result = validateFields(ss.title, ss.desc, cover, files, ss.contacts, ss.latlng, immediately, date, ss.time, ss.repeat, ss.date_end, ss.on_demand);
                            
                            /* datos que sean completamente necesarios */
                            let check = ss.title && ss.desc && cover && files && ss.contacts && ss.latlng && ss.addr && ss.immediately && ss.date && ss.time && ss.repeat && ss.date_end && ss.on_demand;
                            if (result.valid) {
                                console.log("Title");
                                console.log((ss.title));
                                console.log("Desc");
                                console.log((ss.desc));
                                console.log("Cover");
                                console.log(cover);
                                console.log("Files");
                                console.log(files);
                                console.log("Contacts");
                                console.log((ss.contacts));
                                console.log("Latling");
                                console.log((ss.latlng));
                                // console.log(JSON.parse(ss.addr));
                                console.log("Immediately");
                                console.log((immediately));
                                console.log("Date");
                                console.log(date);
                                // console.log("Time");
                                // console.log(JSON.parse(ss.time));
                                // console.log("Repeat");
                                // console.log(JSON.parse(ss.repeat));
                                // console.log("date_end");
                                // console.log(JSON.parse(ss.date_end));
                                // console.log("on_demand");
                                // console.log(JSON.parse(ss.on_demand));
                                
                                //CREATE MEMORY
                                let auxMemory = {
                                    "title": ss.title,
                                    "description": ss.desc,
                                    "owners": [loggedUser.id],
                                    "recipients": "asd",
                                    "reminderType": "location",
                                    "reminder": {},
                                    "sent": false
                                }
                                // await app.request.promise.postJSON(`${app.data.server}/memories`,{
                                //     "title": ss.title,
                                //     "owner": {
                                //         "id": targetUser.id
                                //     },
                                //     "contact":{
                                //         "id": contactUser.id
                                //     },
                                //     "isAdmin": contactIsAdmin,
                                //     "isMinor": contactIsMinor,
                                //     "editMemories": contactEditMemories
                                // })
                                // .then(function (res){
                                //     console.log("response assignRelation");
                                //     console.log(res);
                                //     result.result = true;
                                //     result.message = "Contact added successfully";
                                // })
                                // .catch(function(err){
                                //     console.log("error addignRelation");
                                //     console.log(err);
                                //     result.result = false;
                                //     result.message = err;
                                // })
                                console.log("* * * * Uploading * * * *");
                                
                                
                                // sessionStorage.clear();
                                // app.views.main.router.navigate('/memories/home');
                            }
                            else
                            {
                                console.log("Failed to pass the check thing");
                                console.log(result);
                                app.dialog.alert(`You missed one or more important fields, please fill them; ${result.message}`);
                            }
                            
                        });
                        
                        function validateFields(title, desc, cover, files, contacts, latlng, immediately, date, time, repeat, date_end, on_demand)
                        {
                            // console.log("Starting validateFields");
                            var result = {
                                valid: true,
                                errors: 0,
                                message: "",
                                object: {},
                            };
                            
                            // console.log("Checking title [validateFields]");
                            // console.log(title);
                            // console.log(!title);
                            if (!title)
                            {
                                result.valid = false;
                                result.message += "No title";
                                result.errors++;
                            }
                            
                            // console.log("Checking desc [validateFields]");
                            // console.log(desc);
                            // console.log(!desc);
                            if (!desc)
                            {
                                result.valid = false;
                                result.message += result.errors > 0 ? ", no description" : "No description";
                                result.errors++;
                            }
                            
                            // console.log("Checking cover [validateFields]");
                            // console.log(cover);
                            // console.log(!cover);
                            if (!cover)
                            {
                                result.valid = false;
                                result.message += result.errors > 0 ? ", no cover" : "No cover";
                                result.errors++;
                            }
                            
                            // console.log("Checking files [validateFields]");
                            // console.log(files);
                            // console.log(!(files.length > 0));
                            if (!(files.length > 0))
                            {
                                result.valid = false;
                                result.message += result.errors > 0 ? ", no files" : "No files";
                                result.errors++;
                            }
                            
                            // console.log("Checking contacts [validateFields]");
                            // console.log(contacts);
                            // console.log(!contacts);
                            if (!contacts)
                            {
                                result.valid = false;
                                result.message += result.errors > 0 ? ", no contacts" : "No contacts";
                                result.errors++;
                            }
                            
                            // console.log("Checking latlng [validateFields]");
                            // console.log(latlng);
                            // console.log(!latlng);
                            if (!latlng && plan != "basic")
                            {
                                result.valid = false;
                                result.message += result.errors > 0 ? ", no location" : "No location";
                                result.errors++;
                            }
                            
                            //Send date
                            // console.log("Checking immediately [validateFields]");
                            // console.log(immediately);
                            // console.log(!immediately);
                            if (!immediately)
                            {
                                // console.log("Checking date [validateFields]");
                                // console.log(date);
                                // console.log(!date);
                                if (!date)
                                {
                                    result.valid = false;
                                    result.message += result.errors > 0 ? ", no date" : "No date";
                                    result.errors++;
                                    
                                    //do other checks.
                                }
                            }
                            
                            //title, desc, cover, files, contacts, latlng, addr, immediately, date, time, repeat, date_end, on_demand
                            return result;
                        }
                        
                        function deliverAccept() {
                            console.log("Entering deliver accept")
                            $$('.date-title .edit-btn').removeClass('none');
                            $$('.deliver-cont .btns-cont').addClass('none');
                            $$('.deliver-cont .deliver-info').removeClass('none');
                            let immediately = app.toggle.get('#immediately-toggle').checked;
                            let date = $$('#deliver-date').val();
                            let time = $$('#deliver-time').val();
                            let repeat = $$('#select-repeat p').text();
                            let date_end = $$('#date-end').val();
                            $$('.deliver-cont .deliver-info .footer-deliver').text($$('.popup-deliver .footer').text());
                            $$('.deliver-cont .deliver-info .date-info .val').text(date);
                            $$('.deliver-cont .deliver-info .time-info .val').text(time);
                            sessionStorage.immediately = JSON.stringify(immediately);
                            sessionStorage.date = JSON.stringify(date);
                            sessionStorage.time = JSON.stringify(time);
                            sessionStorage.repeat = JSON.stringify(repeat);
                            sessionStorage.date_end = JSON.stringify(date_end);
                            sessionStorage.footer = JSON.stringify($$('.popup-deliver .footer').text());
                        }
                        
                        /* function coverSessionstorage(val) {
                            sessionStorage.cover = JSON.stringify(val);
                            sessionStorage.mb = JSON.stringify(mb);
                        }
                        */
                        function progressBar(mb) {/* funcion de barra de progreso */
                            let progress = mb / 1000000;
                            let porcent_prog = (progress * 100) / maxmb;
                            app.progressbar.set('#space-progressbar', porcent_prog);
                            $$('.progress-cont .desc #prog').text((maxmb - progress));
                        }
                    },
                },
            }
        </script>