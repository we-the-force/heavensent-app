<template>
    <div class="page" id="location-memory">
        <div class="artwork"></div>
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="header-cont">
                    <div class="header">
                        <a href="" class="back-btn back">
                            <i class="icons material-icons">chevron_left</i>
                        </a>
                        <h1 class="title">Add location</h1>
                        <div class="none"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="page-content">
            <div class="map-cont" id="map">

            </div>
            <div class="inputs list">
                <ul>
                    <li class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-input-wrap">
                                <input type="text" id="direction" placeholder="Direction" />
                                <i class="icons material-icons">edit</i>
                            </div>
                        </div>
                    </li>

                </ul>
            </div>
            <div class="btns-cont center">
                <a href="/memories/create" id="save-location-btn" class="button round color-blue large">Save
                    location</a>
            </div>

        </div>
    </div>
</template>
<script>
    import $$ from "dom7";
    export default {
        on: {
            pageInit: function (e, page) {
                var self = this;
                var app = self.$app;
                var pos = { lat: 25.43, lng: -101.00 };
                var geocoder = new google.maps.Geocoder;
                var input = document.getElementById('direction');
                var searchBox = new google.maps.places.SearchBox(input);
                var marker = $$('<div class="centerMarker"></div>');
                var ubi_btn = $$('<div class="ubi-btn material-icons">my_location</div>');
                var map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 14,
                    center: pos,
                    disableDefaultUI: true
                });
                marker.addClass('centerMarker').appendTo(map.getDiv());
                ubi_btn.appendTo(map.getDiv());

                currentLocation();

                ubi_btn.click(x => {
                    currentLocation();
                    geoCode();
                });

                searchBox.addListener('places_changed', function () {
                    var places = searchBox.getPlaces();
                    if (places.length == 0) {
                        return;
                    } else {
                        let place = places[0];
                        if (!place.geometry) {
                            console.log("Returned place contains no geometry");
                            return;
                        }
                        $$("#direction").val(place.formatted_address);
                        map.setZoom(16);
                        map.setCenter(place.geometry.location);
                    }
                });

                google.maps.event.addListener(map, 'dragend', function () {
                    geoCode();
                });

                $$('#save-location-btn').click(x => {
                    let latlng = { lat: map.getCenter().lat(), lng: map.getCenter().lng() };
                    let addr = $$('#direction').val();
                    console.log(latlng);
                    console.log(addr);                    
                    
                })

                function currentLocation(params) {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            map.setCenter(pos);
                        });
                    }
                }

                function geoCode(params) {
                    let latlng = { lat: map.getCenter().lat(), lng: map.getCenter().lng() };
                    geocoder.geocode({ 'location': latlng }, function (results, status) {
                        if (status === 'OK') {
                            $$("#direction").val(results[0].formatted_address);
                        } else {
                            alert('Geocode was not successful for the following reason: ' + status);
                        }
                    });
                }
            },
        },
    };
</script>