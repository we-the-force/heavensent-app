<template>
    <div class="popup popup-location popup-tablet-fullscreen" id="location-memory">
        <div class="artwork"></div>
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="header-cont">
                    <div class="header">
                        <a href="" class="back-btn back">
                            <i class="icons material-icons">chevron_left</i>
                        </a>
                        <h1 class="title">{{localize "add_loc_header"}}</h1>
                        <div class="none"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="page-content">
            <div class="map-cont" id="map">

            </div>
            <div class="inputs list">
                <ul>
                    <li class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-input-wrap">
                                <input type="text" id="direction" placeholder="{{localize 'add_loc_address'}}" />
                                <i class="icons material-icons">edit</i>
                            </div>
                        </div>
                    </li>

                </ul>
            </div>
            <div class="btns-cont center">
                <a href="#" id="save-location-btn" class="button round color-blue large">{{localize "add_loc_save"}}</a>
            </div>

        </div>
    </div>
</template>
<script>
    import $$ from "dom7";
    export default {
        on: {
            popupOpen: function (e, page) {
                var self = this;
                var app = self.$app;
                /* declara variables 
                    pos: posicion predeterminada
                    geooder: servicio de google para buscar direcciones a partir de lat lng
                    input: pues el input xD
                    searchboX: servicio de gooogle que usa el input para buscar lat lng a partir de la direccion
                    marker: plumita del centro
                    ubi-btn: boton para centrar tu ubicacion
                    map: google map
                */
                var pos = { lat: 25.43, lng: -101.00 };
                var geocoder = new google.maps.Geocoder;
                var input = document.getElementById('direction');
                var searchBox = new google.maps.places.SearchBox(input);
                var marker = $$('<div class="centerMarker"></div>');
                var ubi_btn = $$('<div class="ubi-btn material-icons">my_location</div>');
                var map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 14,
                    center: pos,
                    disableDefaultUI: true
                });

                /* agrego plumita y boton sobre el mapa */
                marker.addClass('centerMarker').appendTo(map.getDiv());
                ubi_btn.appendTo(map.getDiv());

                /* funcion para centrar la ubicacion tuya */
                currentLocation();

                /* click en el boton de centrar ubicacion, centra ubicacion y pone la direccion en el input */
                ubi_btn.click(x => {
                    currentLocation();
                    geoCode();
                });

                /* cuando cambian el input cambia el centro del mapa y la direccion */
                searchBox.addListener('places_changed', () => {
                    var places = searchBox.getPlaces();
                    if (places.length == 0) {
                        return;
                    } else {
                        let place = places[0];
                        if (!place.geometry) {
                            console.log("Returned place contains no geometry");
                            return;
                        }
                        $$("#direction").val(place.formatted_address);
                        map.setZoom(16);
                        map.setCenter(place.geometry.location);
                    }
                });

                /* cuando mueven el mapa obtiene la direccion */
                google.maps.event.addListener(map, 'dragend', () => {
                    geoCode();
                });

                /* boton de salvar locacion
                    latlng: latitud y longitud elegida
                    addr: direccion elegida
                */
                $$('#save-location-btn').click(x => {
                    let latlng = { lat: map.getCenter().lat(), lng: map.getCenter().lng() };
                    let addr = $$('#direction').val();
                    sessionStorage.latlng = JSON.stringify(latlng);
                    sessionStorage.addr = JSON.stringify(addr);
                    app.popup.close();
                })

                /* funcion para centrar en tu ubicacion */
                function currentLocation(params) {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            map.setCenter(pos);
                        });
                    }
                }

                /* funcion para obtener direccion a partir de lat lng */
                function geoCode(params) {
                    let latlng = { lat: map.getCenter().lat(), lng: map.getCenter().lng() };
                    geocoder.geocode({ 'location': latlng }, function (results, status) {
                        if (status === 'OK') {
                            $$("#direction").val(results[0].formatted_address);
                        } else {
                            alert('Geocode was not successful for the following reason: ' + status);
                        }
                    });
                }
            },
            popupClose: async function (e, page) {
                var self = this;
                var app = self.$app;
                var latlng = sessionStorage.latlng;
                var addr = sessionStorage.addr;
                if (latlng && addr) {
                    latlng = JSON.parse(latlng);
                    addr = JSON.parse(addr);
                    $$('.location-cont .location-btn').addClass('none');
                    $$('.location-cont .location-map').removeClass('none');
                    $$('.location-cont .map-info .address .addr').text(addr);
                    let marker = $$('<div class="centerMarker"></div>');
                    var map_2 = new google.maps.Map(document.getElementById("map-static"), {
                        zoom: 14,
                        center: latlng,
                        disableDefaultUI: true,
                        gestureHandling: 'none'
                    });
                    marker.addClass('centerMarker').appendTo(map_2.getDiv());
                }
            },
        },
    };
</script>