<template>
    <div class="popup popup-contacts popup-tablet-fullscreen" id="add-contacts">
        <div class="artwork"></div>
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="header-cont">
                    <div class="header">
                        <a href="" class="back-btn popup-close">
                            <i class="icons material-icons">chevron_left</i>
                        </a>

                        <h1 class="title">{{localize 'my_family'}}</h1>
                        <div class="none"></div>
                        <!-- <a href="" class="add-btn link">
                            <i class="icons material-icons">add</i>
                        </a> -->
                    </div>
                </div>
                <div class="subnavbar">
                    <form class="searchbar">
                        <div class="searchbar-inner">
                            <div class="searchbar-input-wrap">
                                <input type="search" placeholder="Search" />
                                <i class="searchbar-icon"></i>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="page-content">
            <div class="sqr_bck" id="sqr1"></div>
            <div class="sqr_bck" id="sqr2"></div>
            <div class="sqr_bck" id="sqr3"></div>
            <div id="family-list" class="family-cont list searchbar-found media-list">
                <ul>

                </ul>
            </div>
            <div class="btns-cont center">
                <a href="#" id="add-contact-btn" class="button round color-blue large">Add to memory</a>
            </div>

            <div class="block searchbar-not-found">
                <div class="block-inner">Nothing found</div>
            </div>
        </div>
    </div>
</template>
<script>
    import $$ from "dom7";
    export default {
        on: {
            popupOpen: async function(e, page) {
                var self = this;
                var app = self.$app;

                var contacts = await app.methods.getLocalValue('loggedUserContacts');
                if (contacts) {
                    //TODO
                    contacts.forEach(element => {
                        // console.log(`Loading Contact ${element.nickname}`, element);
                        // let picture = element.contact.profilePicture != null ? app.data.server + element.contact.profilePicture.url : "";
                        let picture = element.contactPicture != null ? app.data.server + element.contactPicture.url : (element.contact.profilePicture != null ? app.data.server + element.contact.profilePicture.url : "");
                        let email = element.contactEmail != null ? element.contactEmail : element.contact.username;
                        $$('<li>' +
                            '<label class="item-checkbox item-content" data-id="' + element.contact.id + '">' +
                            '<input type="checkbox" class="chckbx" name="contact-checkbox" value="" />' +
                            '<div class="item-media"><img src="' + picture + '" width="44" /></div>' +
                            '<div class="item-inner">' +
                            '<div class="item-title-row">' +
                            '<div class="item-title">' + element.nickname + '</div>' +
                            // '<div class="item-text">' + email + '</div>' +
                            '</div>' +
                            '<div class="item-text">' + element.relation + '</div>' +
                            '</div>' +
                            '</label>' +
                            '</li>').appendTo('.family-cont ul');
                    });
                }

                $$('.chckbx').change(function(val) {
                    $$(this).parent().parent().toggleClass('checked');
                });

                //$$('.add-btn').click(x => {
                //    e.preventDefault();
                //    app.views.main.router.navigate(`/contact/create`, {
                //        clearPreviousHistory: true
                //    });
                //});

                $$('#add-contact-btn').click(function(params) {
                    let contacts = [];
                    $$('input[type=checkbox]:checked').each(function(val) {
                        let contact = {};
                        contact.id = $$(this).parent().data('id');
                        contact.img = $$(this).next().children('img').attr('src');
                        contacts.push(contact);
                    });

                    if (sessionStorage.contacts) {
                        //trae los contactos ya agregados antes
                        let contacts_2 = JSON.parse(sessionStorage.contacts);
                        //los junta con los que se seleccionaron ahora
                        let merge = contacts_2.concat(contacts);
                        //hace magia para que los que se repiten no salgan 2 veces
                        let unique = merge.map(e => e['id']).map((e, i, final) => final.indexOf(e) === i && i).filter((e) => merge[e]).map(e => merge[e]);
                        //los guarda en session storage
                        sessionStorage.contacts = JSON.stringify(unique);
                    } else {
                        sessionStorage.contacts = JSON.stringify(contacts);
                    }

                    app.popup.close();
                });

                var searchbar = app.searchbar.create({
                    el: ".searchbar",
                    searchContainer: ".list",
                    searchIn: ".item-title, .item-text",
                    on: {
                        search(sb, query, previousQuery) {
                            console.log(query, previousQuery);
                        },
                    },
                });
            },
            popupClose: async function(e, page) {
                var self = this;
                var app = self.$app;
                var contacts = sessionStorage.contacts;

                if (contacts) {
                    contacts = JSON.parse(contacts);
                    $$('.contacts-cont .contacts .person.contact').remove();
                    contacts.length > 0 ? $$('.contacts-cont .contacts .person.no_contact').addClass('none') : $$('.contacts-cont .contacts .person.no_contact').removeClass('none');
                    contacts.forEach(el => {
                        let contact = $$('<div class="person contact" data-id="' + el.id + '">' +
                            '<span class="material-icons close">close</span>' +
                            '<img src="' + el.img + '" alt="">' +
                            '</div>')
                        contact.appendTo($$('.contacts-cont .contacts'));
                    });
                }

                $$('.person.contact .close').click(function(val) {
                    contacts.splice(contacts.indexOf(contacts.find(x => x.id == $$(this).parent().data('id'))), 1);
                    sessionStorage.contacts = JSON.stringify(contacts);
                    $$(this).parent().remove();
                    if (contacts.length == 0) $$('.contacts-cont .contacts .person.no_contact').removeClass('none');
                });
            },
        },
    };
</script>