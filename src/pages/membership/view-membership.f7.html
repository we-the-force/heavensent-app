<template>
    <div class="page" id="membership-view">
        <div class="artwork"></div>
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="header-cont">
                    <div class="header">
                        <a href="/memories/home/user/-1" class="back-btn">
                            <i id="" class="icons material-icons">chevron_left</i>
                        </a>
                        <h1 class="title">{{localize "membership"}}</h1>
                        <div class="none"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="page-content">
            <div class="logo-cont">
                <img src="static/img/Pluma_blue.png" alt="" />
            </div>
            <div class="title-cont">
                <!-- <h1>Hello Jacob</h1> -->
                <h1>{{UserName}}</h1>
                <p>{{localize "text_thanks_membership"}}</p>
                <p id="canceled-membership-text" style="color:red"></p>
            </div>
            <div class="text-cont">
                <!-- <h1 class="text-title" id="package-name">Package 3 membership</h1> -->
                <!-- <p class="text-cost" id="package-cost">$15.00 USB /MO</p> -->
                <h1 class="text-title" id="package-name">{{PlanName}}</h1>
                <!-- <p class="text-cost" id="package-cost">${{PlanPrice}}.00 USD /MO</p> -->
                <!-- <p class="text-cost" id="package-cost">$0.00 USD {{localize "view_membership_next_month"}}</p> -->

                <!-- <p class="text">
                    {{localize "next_billing_date"}} <span id="next-bill-date">{{BillingDate}}</span>
                </p> -->
                <!-- <p class="text mar-t15">
                    {{localize "billed_with"}} 
                    <a class="card-info" id="billing-info">
                        {{BilledCard}}
                        <span id="edit-billing-info-btn" class="material-icons">edit</span>
                    </a>
                </p> -->
            </div>

            <div class="btns-cont center">
                <a id="change-plan-btn" class="button color-white round large">{{localize "change_plan"}}</a>
            </div>
            <div class="btns-cont center">
                <a id="cancel-plan-btn" class="button color-blue round large">{{localize "cancel_subs"}}</a>
            </div>
        </div>
    </div>
</template>
<script>
    import $$ from "dom7";
    export default {
        on: {
            pageInit: async function() {
                var self = this;
                var app = self.$app;
                var stripeApiUrl = app.data.stripe.stripeApiUrl;
                var PUBLISHABLE_KEY = app.data.stripe.testKeys.pk;
                var SECRET_KEY = app.data.stripe.testKeys.sk;
                //var stripeRedirect = await loadStripe(PUBLISHABLE_KEY);

                const stripe = require('stripe')(SECRET_KEY);

                var moment = require('moment');
                moment.locale('es');
                moment().format();

                await app.methods.updateCurrentUser();
                var loggedUser = await app.methods.getLocalValue('loggedUser');
                await updateControls();


                $$("#cancel-plan-btn").on("click", async function(e) {
                    e.preventDefault();

                    app.dialog.confirm(window.localize('cancel_subs_dialog'), window.localize('cancel_subs'), handleCancel)

                    // loggedUser = null;
                    // await app.methods.clearCurrentUser();
                    // console.log("User cleared [app.f7.signout]");
                    // await app.views.main.router.navigate('/');
                    // console.log("Logging out [pageInit.sign-out-btn.onClick]");
                    // if (await app.methods.setLocalValueToKey(null, 'loggedUser'))
                    // {
                    // 	console.log("Successfully logged out! [pageInit.sign-out-btn.onClick]");
                    // 	app.views.main.router.navigate({ name: "login" });
                    // }
                });

                async function handleCancel() {
                    let updateResponse;
                    let token = loggedUser.currentMembership.token;
                    let headers = {
                        'Authorization': 'Bearer ' + SECRET_KEY,
                    }
                    let today = moment();
                    let creation_date = moment.unix(loggedUser.currentMembership.creation_date);
                    let chargeID, refund;

                    if (today.isSameOrBefore(creation_date.add(30, 'd'))) {
                        app.preloader.show('blue');
                        await app.request.promise({
                            url: `${stripeApiUrl}payment_intents/${token}`,
                            method: "GET",
                            headers: headers
                        }).then(function(payIntResult) {
                            let pi = JSON.parse(payIntResult.data);
                            chargeID = pi.charges.data[0].id;
                        }).catch(async function(error) {
                            app.preloader.hide();
                            await app.dialog.alert(`Oops error consiguiendo el id de tu pago ${error}`)
                            app.views.main.router.navigate('/');
                        });

                        await app.request.promise({
                            url: `${stripeApiUrl}refunds`,
                            method: "POST",
                            data: {
                                charge: chargeID,
                            },
                            headers: headers
                        }).then(function(resRefund) {
                            let refund = JSON.parse(resRefund.data);
                        }).catch(async function(error) {
                            app.preloader.hide();
                            await app.dialog.alert(`Oops error realizando el reembolso ${error}`)
                            app.views.main.router.navigate('/');
                        });

                        await app.request.promise({
                            url: `${app.data.server}/users/${loggedUser.id}`,
                            method: 'PUT',
                            data: {
                                "currentMembership": {
                                    "isActive": false,
                                }
                            }
                        }).then(async function(value) {
                            app.preloader.hide();
                            await app.dialog.alert("Membership canceled successfully!");
                            app.views.main.router.navigate('/');
                        }).catch(async function(error) {
                            app.preloader.hide();
                            await app.dialog.alert(`Oops error borrando tu membresia ${error}`)
                            app.views.main.router.navigate('/');
                        });
                    } else {
                        app.dialog.confirm(window.localize('cancel_subs_no_refund'), window.localize('cancel_subs'), x => {
                            app.preloader.show('blue');
                            app.request.promise({
                                url: `${app.data.server}/users/${loggedUser.id}`,
                                method: 'PUT',
                                data: {
                                    "currentMembership": {
                                        "isActive": false,
                                    }
                                }
                            }).then(async function(value) {
                                app.preloader.hide();
                                await app.dialog.alert("Membership canceled successfully!");
                                app.views.main.router.navigate('/');
                            }).catch(async function(error) {
                                app.preloader.hide();
                                await app.dialog.alert(`Oops error borrando tu membresia ${error}`)
                                app.views.main.router.navigate('/');
                            });
                        });
                        //console.log('alert about no refund');
                        //await stripe.paymentIntents.cancel(token);
                    }

                    /* await app.request.promise({
                        url: `${app.data.stripe.subscriptionUrl}/${loggedUser.currentMembership.token}?cancel_at_period_end=true`,
                        method: "POST",
                        headers: {
                            'Authorization': `Bearer ${app.data.stripe.testKeys.sk}`
                        },
                    }).then(async function(updateResponse) {
                        let updateData = JSON.parse(updateResponse.data);
                        console.log(updateData);

                        let endDate = new Date(updateData.current_period_end * 1000);
                        app.dialog.alert(`${window.localize('cancel_subs_canceled')} ${endDate}`);

                        let asd = await app.request({
                            url: `${app.data.server}/users/${loggedUser.id}`,
                            method: 'PUT',
                            data: {
                                "currentMembership": {
                                    "isActive": loggedUser.currentMembership.isActive,
                                    "nextBillingDate": loggedUser.currentMembership.nextBillingDate,
                                    "plan": loggedUser.currentMembership.plan.id,
                                    "token": loggedUser.currentMembership.token,
                                    "billedCard": loggedUser.currentMembership.billedCard,
                                    "cancelOnPeriodEnd": true
                                }
                            }
                        });

                        await app.methods.updateCurrentUser();

                        app.views.main.router.refreshPage();
                    }); */

                }

                function nocancelMembership() {
                    console.log("Que dice mi mama que siempre no");
                }

                async function updateControls() {
                    console.log("UpdateControls()")
                    $$("#change-plan-btn")[0].href = `/membership/select/user/${loggedUser.id}/clear/0`;
                    if (loggedUser.currentMembership.cancelOnPeriodEnd) {
                        //console.log($$("#canceled-membership-text")[0]);

                        $$("#canceled-membership-text")[0].innerText = window.localize('view_membership_cancel');

                        console.log("Canceling membership unu");
                    } else {
                        await app.request.promise({
                            url: `${app.data.stripe.stripeApiUrl}invoices/upcoming?subscription=${loggedUser.currentMembership.token}`,
                            method: 'GET',
                            headers: {
                                'Authorization': 'Bearer ' + app.data.stripe.testKeys.sk
                            }
                        }).then(function(upInvRes) {
                            let data = JSON.parse(upInvRes.data);
                            let formattedNumber = formatAmountNumber(data.amount_due / 100);
                            let formattedText = `$${formattedNumber} USD ${window.localize('view_membership_next_month')}`
                            $$('#package-cost')[0].innerText = formattedText;
                        }).catch(function(err) {
                            console.log("Error in upcomingInvoice");
                            console.log(err);
                        });
                    }
                }

                function formatAmountNumber(toFormat) {
                    var splitAmount = toFormat.toString().split('.');
                    var formattedAmount = `${splitAmount[0]}.${(splitAmount.length > 1 ? formatSingleNumber(splitAmount[1]) : "00")}`;
                    return formattedAmount;
                }

                function formatSingleNumber(number) {
                    switch (number.toString().length) {
                        case 0:
                            return "00";
                            break;
                        case 1:
                            return number + "0";
                            break;
                        case 2:
                            return number;
                            break;
                    }
                }

            }
        },
    };
</script>