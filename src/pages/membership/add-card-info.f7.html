<template>
	<div class="page" id="add-card-info">
		<div class="artwork"></div>
		<div class="navbar">
			<div class="navbar-inner sliding">
				<div class="header-cont">
					<div class="header">
						<a href="" class="back-btn back">
							<i class="icons material-icons">chevron_left</i>
						</a>
						<h1 class="title">Add card info</h1>
						<div class="none"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="page-content">
			<div class="logo-cont">
				<img src="../../static/img/card.png" alt="" />
			</div>
			<div class="inputs list">
				<ul>
					<li class="item-content item-input with-label">
						<label for="name">Name on card</label>
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="text" id="name" placeholder="Name on card" required validate />
							</div>
						</div>
					</li>
					<li class="item-content item-input with-label">
						<label for="number">Number card</label>
						<div class="item-inner">
							<div class="item-input-wrap">
								<input type="number" id="number" placeholder="Credit card" required validate />
							</div>
						</div>
					</li>
					<li class="item-content item-input two-inputs">
						<div class="item-inner padd-r20 col-65">
							<div class="item-input-wrap">
								<input type="month" id="expires" placeholder="Expires" required validate />
							</div>
						</div>
						<div class="item-inner col-25">
							<div class="item-input-wrap">
								<input type="password" id="csv" placeholder="CSV" required validate />
							</div>
						</div>
					</li>
				</ul>
			</div>
			<div class="btns-cont center">
				<!-- <a id="confirm" href="/membership/confirmed" class="button color-blue round small">Confirm</a> -->
				<a id="confirm" class="button color-blue round small">Confirm</a>
			</div>
		</div>
	</div>
</template>]
<script>
	import $$ from "dom7";
	import croppie from "croppie";
	export default {
		on: {
			pageInit: function(e, page){
				var self = this;
				var app = self.$app;
				
				var queryPlan = app.views.main.router.currentRoute.params.planName;
				var queryID = app.views.main.router.currentRoute.params.userID;
				console.log(queryPlan);
				console.log(queryID);
				var wea = formatDate();
				console.log(wea);
				
				// $$("#confirm")[0].href = `/membership/confirmed/?plan=${queryPlan}`;
				$$("#confirm").click(function (val) {
					console.log(`/membership/view/users/${queryID}`);
					console.log("Getting plan")
					app.request.promise.get(`${app.data.server}/memberships/?name=${queryPlan}`)
					.then(function(planRes){
						let plan = JSON.parse(planRes.data)[0];
						console.log(plan);
						console.log(plan.id);
						console.log("Getting user");
						console.log(`${app.data.server}/memberships/?name=${queryPlan}`);
						app.request.promise.get(`${app.data.server}/users/${queryID}`)
						.then(function(userRes){
							console.log("Inserting membership");
							app.request({
								url: `${app.data.server}/users/${queryID}`,
								method: 'PUT',
								data:{
									"currentMembership": {
										"isActive": true,
										"nextBillingDate": formatDate(),
										"billedCard": 123123,
										"plan": plan.id
									}
								}
							});
							console.log(`/membership/view/user/${queryID}`);
							// app.views.main.router.navigate({ path: '/membership/select/user/' + queryID });
							app.views.main.router.navigate({ 
								name: 'view-membership',
								params: { userID: queryID },
							});
							
						})
					})
				});
				
				function formatDate()
				{
					let date = new Date();
					date.setDate(date.getDate() + 30);
					let dd = String(date.getDate()).padStart(2, '0');
					let mm = String(date.getMonth() + 1).padStart(2, '0');
					let yyyy = date.getFullYear();
					let hour = date.getHours();
					
					//2020-06-11T19:00:00.000Z
					let result = `${yyyy}-${mm}-${dd}T${hour}:00:00.000Z`;
					
					return result;
				}
			}
		},
	};
</script>
