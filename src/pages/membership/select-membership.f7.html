<template>
	<div class="page" id="select-membership">
		<div class="artwork"></div>
		<div class="navbar">
			<div class="navbar-inner sliding">
				<div class="header-cont">
					<div class="header">
						<!-- <a id="membership-select-back" href="" class="back-btn back"> -->
						<a id="membership-select-back" href="" class="back-btn">
							<i class="icons material-icons">chevron_left</i>
						</a>
						<h1 class="title">{{localize "select_package"}}</h1>
						<div class="none"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="page-content">
			<div class="text-cont">
				<h1 class="title2">{{localize "choose_plan"}}</h1>
				<p class="text">{{localize "down_and_up"}}</p>
			</div>
			<div class="plans-cont">
				<div class="btns-cont">
					<a class="button-plan plan-a active" id="plan-a">
						<h2 class="title-plan">{{localize "basic"}}</h2>
						<div class="price-cont">
							<p class="symbol">$</p>
							<p class="price">5</p>
						</div>
						<p class="per-month">{{localize "per_month"}}</p>
					</a>
					<a class="button-plan plan-b" id="plan-b">
						<h2 class="title-plan">{{localize "standard"}}</h2>
						<div class="price-cont">
							<p class="symbol">$</p>
							<p class="price">15</p>
						</div>
						<p class="per-month">{{localize "per_month"}}</p>
					</a>
					<a class="button-plan plan-c" id="plan-c">
						<h2 class="title-plan">{{localize "premium"}}</h2>
						<div class="price-cont">
							<p class="symbol">$</p>
							<p class="price">25</p>
						</div>
						<p class="per-month">{{localize "per_month"}}</p>
					</a>
				</div>
				<p class="title3">{{localize "text_notes"}}</p>
				<div class="icons-cont" id="text-notes">
					<div class="icon">
						<span id="package-a-tex-notes" class="plan plan-a material-icons active">done</span>
					</div>
					<div class="icon">
						<span id="package-b-tex-notes" class="plan plan-b material-icons">done</span>
					</div>
					<div class="icon">
						<span id="package-c-tex-notes" class="plan plan-c material-icons">done</span>
					</div>
				</div>
				<p class="title3">{{localize "pictures"}}</p>
				<div class="icons-cont" id="pictures">
					<div class="icon">
						<span id="package-a-pictures" class="plan plan-a material-icons active">done</span>
					</div>
					<div class="icon">
						<span id="package-b-pictures" class="plan plan-b material-icons">done</span>
					</div>
					<div class="icon">
						<span id="package-c-pictures" class="plan plan-c material-icons">done</span>
					</div>
				</div>
				<p class="title3">Video</p>
				<div class="icons-cont" id="video">
					<div class="icon">
						<span id="package-a-video" class="plan plan-a material-icons active">clear</span>
					</div>
					<div class="icon">
						<span id="package-b-video" class="plan plan-b material-icons">done</span>
					</div>
					<div class="icon">
						<span id="package-c-video" class="plan plan-c material-icons">done</span>
					</div>
				</div>
				<p class="title3">GPS</p>
				<div class="icons-cont" id="gps">
					<div class="icon">
						<span id="package-a-gps" class="plan plan-a material-icons active">clear</span>
					</div>
					<div class="icon">
						<span id="package-b-gps" class="plan plan-b material-icons">clear</span>
					</div>
					<div class="icon">
						<span id="package-c-gps" class="plan plan-c material-icons">done</span>
					</div>
				</div>
				<p class="title3">{{localize "on_demand"}}</p>
				<div class="icons-cont" id="demand">
					<div class="icon">
						<span id="package-a-demand" class="plan plan-a material-icons active">clear</span>
					</div>
					<div class="icon">
						<span id="package-b-demand" class="plan plan-b material-icons">clear</span>
					</div>
					<div class="icon">
						<span id="package-c-demand" class="plan plan-c material-icons">done</span>
					</div>
				</div>
				<div class="desc-cont">
					<div class="item">
						<p id="package-a-desc" class="plan plan-a active">6 {{localize "desc_select_membership"}}</p>
					</div>
					<div class="item">
						<p id="package-b-desc" class="plan plan-b">6 {{localize "desc_select_membership"}}</p>
					</div>
					<div class="item">
						<p id="package-c-desc" class="plan plan-c">12 {{localize "desc_select_membership"}}</p>
					</div>
				</div>
			</div>
			<div id="btn-cont" class="btns-cont center">
				<!-- <a id="confirm-plan-btn" href="/membership/card/" class="button color-blue round large">Select plan</a> -->
				<!-- <a id="confirm-plan-btn" href="/membership/card/?plan=basic" class="button color-blue round large">{{localize "select_plan"}}</a> -->
				<a id="confirm-plan-btn" href="" class="button color-blue round large">{{localize "select_plan"}}</a>
			</div>
		</div>
	</div>
</template>
<script>
	import $$ from "dom7";
	export default {
		// auth/local/register
		on: {
			pageMounted: async function(){
			},
			pageInit: async function (e, page) {
				var self = this;
				var app = self.$app;
				var paymentToken;
				var queryID = app.views.main.router.currentRoute.params.userID;
				var clearOnBack = app.views.main.router.currentRoute.params.clearOnBack;
				var loggedUser = await app.methods.getLocalValue('loggedUser');
				console.log("Intro thing");
				var plans = await getPlans();
				console.log("plans");
				console.log(plans);
				var selectedPlan = plans[0];
				console.log("Selected PLan");
				console.log(selectedPlan);

				var PUBLISHABLE_KEY = app.data.stripe.testKeys.pk;
				var SECRET_KEY = app.data.stripe.testKeys.sk;
				var DOMAIN = app.data.domain;
				var memberships = app.data.stripe.memberships;
				var stripeUrl = app.data.stripe.stripeUrl;

				var stripe = Stripe(PUBLISHABLE_KEY);

				function redirectToCheckout()
				{
					// let lineItems = [{price: price_id, quantity:1}];
					// let successUrl = `http://success.html?session_id={CHECKOUT_SESSION_ID}`;
					let successUrl = `http://app.heavensent.com/#!/membership/confirmed/session/{CHECKOUT_SESSION_ID}/plan/${selectedPlan.id}`;
					let cancelUrl = `https://app.heavensentnow.com/#!/membership/view/user/${loggedUser.id}`;
					let line_items =  [{
						price_data: {
							currency: "usd",
							product: selectedPlan.stripeId,
							unit_amount: (selectedPlan.cost * 100),
							recurring: {
								interval: 'month',
							}
						},
						quantity: 1,
					}];

					//Ahorita esta hardcodeado, acomodalo al ratito pls;
					// let cancelUrl = `http://canceled.html`;

					let object = {
						line_items: line_items,
						success_url: successUrl,
						cancel_url: cancelUrl,
						customer_email: loggedUser.email,
						payment_method_types: ['card'],
						mode: 'subscription'
					};
					
					console.log("object");
					console.log(object);

					// app.request.setup({headers: {'Authorization': 'Bearer ' + app.data.stripe.testKeys.sk}});

					app.request.promise({
						url: stripeUrl,
						method: "POST",
						data: object,
						headers: {'Authorization': 'Bearer ' + app.data.stripe.testKeys.sk}
					}).then(function(res){
						var sessionData = JSON.parse(res.data);
						console.log(sessionData.id);
						app.request.setup({headers: {'Authorization': ''}});
						stripe.redirectToCheckout({sessionId: sessionData.id});
					})
				}
				/*
				function handleResult(result)
				{
					console.log(result);
					if (result.error)
					{
						console.log(result.error.message);
					}
				}

				const baseRequest = {
					apiVersion: 2,
					apiVersionMinor: 0
				};
				
				const allowedCardNetworks = ["AMEX", "DISCOVER", "INTERAC", "JCB", "MASTERCARD", "VISA"];
				const allowedCardAuthMethods = ["PAN_ONLY", "CRYPTOGRAM_3DS"];

				const tokenizationSpecification = {
					type: 'PAYMENT_GATEWAY',
					parameters: {
							'gateway': 'example',
							'gatewayMerchantId': 'exampleGatewayMerchantId'
					}
				};
				
				const baseCardPaymentMethod = {
					type: 'CARD',
					parameters: {
							allowedAuthMethods: allowedCardAuthMethods,
							allowedCardNetworks: allowedCardNetworks
					}
				};
				
				const cardPaymentMethod = Object.assign(
					{},
					baseCardPaymentMethod,
					{
							tokenizationSpecification: tokenizationSpecification
					}
				);
			
				let paymentsClient = null;

				function getGoogleIsReadyToPayRequest() {
					return Object.assign(
									{},
									baseRequest,
									{
											allowedPaymentMethods: [baseCardPaymentMethod]
									}
					);
				}
				
				function getGooglePaymentDataRequest() {
					const paymentDataRequest = Object.assign({}, baseRequest);
					paymentDataRequest.allowedPaymentMethods = [cardPaymentMethod];
					paymentDataRequest.transactionInfo = getGoogleTransactionInfo();
					paymentDataRequest.merchantInfo = {
							// @todo a merchant ID is available for a production environment after approval by Google
							// See {@link https://developers.google.com/pay/api/web/guides/test-and-deploy/integration-checklist|Integration checklist}
							merchantId: '247883957',
							merchantName: 'HeavenSent'
					};
					return paymentDataRequest;
				}
			
				function getGooglePaymentsClient() {
					if ( paymentsClient === null ) {
							paymentsClient = new google.payments.api.PaymentsClient({environment: 'TEST'});
					}
					return paymentsClient;
				}

				// function onGooglePayLoaded() {
				// 	const paymentsClient = getGooglePaymentsClient();
				// 	paymentsClient.isReadyToPay(getGoogleIsReadyToPayRequest())
				// 					.then(function(response) {
				// 							if (response.result) {
				// 									addGooglePayButton();
				// 									// @todo prefetch payment data to improve performance after confirming site functionality
				// 									// prefetchGooglePaymentData();
				// 							}
				// 					})
				// 					.catch(function(err) {
				// 							// show error in developer console for debugging
				// 							console.error(err);
				// 					});
				// }
				
				function addGooglePayButton(buttonId) {
					const paymentsClient = getGooglePaymentsClient();
					const button =
									paymentsClient.createButton({onClick: onGooglePaymentButtonClicked});
					document.getElementById('btn-cont').appendChild(button);
				}
			
				function getGoogleTransactionInfo() {
					let aux = {
							countryCode: 'US',
							currencyCode: 'USD',
							totalPriceStatus: 'FINAL',
							// set to cart total
							totalPrice: selectedPlan != undefined ? selectedPlan.cost.toString() : '5.00'
					};
					console.log("Transaction info changed");
					console.log(selectedPlan);
					console.log(aux);
					return aux;
				}

				function prefetchGooglePaymentData() {
					const paymentDataRequest = getGooglePaymentDataRequest();
					// transactionInfo must be set but does not affect cache
					paymentDataRequest.transactionInfo = {
							totalPriceStatus: 'NOT_CURRENTLY_KNOWN',
							currencyCode: 'USD'
					};
					const paymentsClient = getGooglePaymentsClient();
					paymentsClient.prefetchPaymentData(paymentDataRequest);
				}

				function onGooglePaymentButtonClicked() {
					const paymentDataRequest = getGooglePaymentDataRequest();
					paymentDataRequest.transactionInfo = getGoogleTransactionInfo();
					console.log("transactionInfo:");
					console.log(paymentDataRequest.transactionInfo);

					const paymentsClient = getGooglePaymentsClient();
					paymentsClient.loadPaymentData(paymentDataRequest)
									.then(function(paymentData) {
											// handle the response
											console.log("Then:");
											console.log(paymentData);
											console.log("Do the thing with the membership como no");
											processPayment(paymentData);
											assignPlan(paymentData);
									})
									.catch(function(err) {
											// show error in developer console for debugging
											console.log("Error en el cositos")
											console.error(err);
									});
				}

				function processPayment(paymentData) {
					// show returned data in developer console for debugging
							console.log(paymentData);
					// @todo pass payment token to your gateway to process payment
					paymentToken = paymentData.paymentMethodData.tokenizationData.token;
				}

				// app.methods.loadscript('https://pay.google.com/gp/p/js/pay.js', function(){
				// 	const paymentsClient = getGooglePaymentsClient();
				// 	paymentsClient.isReadyToPay(getGoogleIsReadyToPayRequest())
				// 					.then(function(response) {
				// 							if (response.result) {
				// 									addGooglePayButton();
				// 									// @todo prefetch payment data to improve performance after confirming site functionality
				// 									// prefetchGooglePaymentData();
				// 							}
				// 					})
				// 					.catch(function(err) {
				// 							// show error in developer console for debugging
				// 							console.error(err);
				// 					});
				// } )
				*/
				$$("#confirm-plan-btn").on('click', function(asd){
					console.log("Click!");
					console.log(asd);
					redirectToCheckout();
				});

				// console.log("select-membership pageInit");
				// console.log(queryID);
				
				console.log("**Previous Path**")
				console.log(app.views.main.router.previousRoute.route);

				changeConfirmButtonHref(selectedPlan);

				$$(".button-plan").click(function (val) {
					let el = $$(this);
					console.log(el);
					if (!el.hasClass("active")) {
						selectedPlan = getIndex(el[0].id);
						console.log(selectedPlan);
						// el[0].href = selectedPlan;
						changeConfirmButtonHref(selectedPlan);
						el.siblings(".active").removeClass("active");
						el.addClass("active");
						$$(".plan").removeClass("active");
						$$("."+el.attr('id')).addClass("active");
					}
				});
				
				$$("#membership-select-back").click(async function (val){
					if (await app.methods.userHasValidMembership())
					{
						console.log("membership was valid, not clearing it c:");
						await app.views.main.router.navigate(`/membership/view/user/${queryID}`);
					}
					else
					{
						val.preventDefault();
						console.log("membership not valid, clearing user");
						await app.methods.clearCurrentUser();
						console.log("user should now be null!!");
						console.log(await app.methods.getLocalValue('loggedUser'));
						console.log("Going to login now");
						await app.views.main.router.navigate('/');
					}
				})

				function changeConfirmButtonHref(extraRef)
				{
					// console.log($$("#confirm-plan-btn"));
					// $$("#confirm-plan-btn")[0].href = `/membership/card/user/${queryID}/plan/${extraRef}`;
				}
				
				function getIndex(buttonId)
				{
					switch(buttonId)
					{
						case "plan-a":
							console.log("Setting thing");
							return plans[0];
						// return "basic";
						case "plan-b":
							return plans[1];
						// return "standard";
						case "plan-c":
							return plans[2];
						// return "premium";
					}
				}

				async function assignPlan(paymentData)
				{
					await app.request.promise.get(`${app.data.server}/memberships/?name=${selectedPlan.name}`).then(async function(planRes){
						let plan = JSON.parse(planRes.data)[0];
						await app.request.promise.get(`${app.data.server}/users/${queryID}`).then(async function(userRes){
							console.log("Inserting membership");
							await app.request({
								url: `${app.data.server}/users/${queryID}`,
								method: 'PUT',
								data:{
									"currentMembership": {
										"isActive": true,
										"nextBillingDate": formatDate(true, true),
										"plan": plan.id,
										"token": paymentToken,
										"billedCard": paymentData.paymentMethodData.description
									}
								}
							});

							var loggedUser = await app.methods.getLocalValue('loggedUser');
							console.log("Logged user:");
							console.log(loggedUser);

							var userEmail = loggedUser.email;
							console.log("----- email: " + userEmail);

							await app.request.promise.postJSON(`${app.data.server}/payments`,{
								"token": paymentToken,
								"user": queryID,
								"date": formatDate(false, false),
								"concept": `${capitalize(selectedPlan.name)} membership for HeavenSent`,
								"amountUSD": `${selectedPlan.cost}`,
								"userEmail": userEmail
							})

							await app.methods.updateCurrentUser();

							//If no errors present
							app.views.main.router.navigate('/membership/confirmed');
						}).catch(function(err){
							console.log(`There was an error fetching the current user (id: ${queryID})`);
							console.log(err);
						})
					}).catch(function(err){
						console.log(`There was an error fetching the plan! (name: ${selectedPlan.name})`);
						console.log(err);
					})
				}

				async function getPlans()
				{
					let plansRes = await app.request.promise.json(`${app.data.server}/memberships`);
					let planList = [];
					plansRes.data.forEach(plan => {
						planList.push({
							id: plan.id,
							stripeId: plan.stripeID,
							name: plan.name,
							cost: plan.costPerMonth
						});
                    	// memObject.push(getMemory(mem));
					})
					return planList;
				}
				function capitalize(text)
				{
					if (typeof text !== 'string') return ''
					return text.charAt(0).toUpperCase() + text.slice(1);
				}
				function formatDate(includeTime, nextMonth)
				{
					let date = new Date();
					if (nextMonth)
					{
						date.setDate(date.getDate() + 30);
					}
					let dd = String(date.getDate()).padStart(2, '0');
					let mm = String(date.getMonth() + 1).padStart(2, '0');
					let yyyy = date.getFullYear();
					let hour = date.getHours();
					
					//2020-06-11T19:00:00.000Z
					let result;
					
					if (includeTime)
					{
						result = `${yyyy}-${mm}-${dd}T${hour}:00:00.000Z`;
					}
					else
					{
						result = `${yyyy}-${mm}-${dd}`;
					}
					return result;
				}
			},
		},
	};
</script>
