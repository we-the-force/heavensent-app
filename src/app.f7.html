<template>
	<div id="app">
		<div class="panel panel-left panel-cover panel-init">
			<div class="sqr_bck" id="sqr1"></div>
			<div class="sqr_bck" id="sqr2"></div>
			<div class="sqr_bck" id="sqr3"></div>
			<div class="profile">
				<div class="avatar">
					<img id="side-logged-user-picture" src="../../static/img/chris_evans_crop1569801286473.png" alt="">
				</div>
				<div class="text">
					<div class="name-cont">
						<h1 id="side-logged-user-name" class="name capitalize"></h1>
						<a href="" id="edit-profile" class="panel-close">
							<span class="material-icons">edit</span>
						</a>
					</div>
					<p id="side-logged-user-membership">Membership</p>
				</div>
			</div>

			<div class="btns-cont">
				<a id="profile-btn" href="/memories/home"
					class="btn-panel panel-close active">{{localize "profile"}}</a>
				<a id="app-plan-button" href="/membership/view/user/"
					class="btn-panel panel-close ">{{localize "plan"}}</a>
				<a id="app-plan-button" href="/ondemand"
					class="btn-panel panel-close ">{{localize "ondemand"}}</a>
				<!-- herdcoded -->
				<!-- <a href="/donations" class="btn-panel panel-close ">{{localize "donate"}}</a> -->
			</div>

			<div class="footer">
				<a href="#" class="btn-end panel-close lenguage" id="lenguage">{{localize "lenguage"}}</a>
				<a href="/UserAgreement" class="btn-end panel-close terms">{{localize "terms_and_conds"}}</a>
				<a href="/" class="btn-end panel-close sign-out" id="sign-out-btn">{{localize "sign_out"}}</a>
			</div>
		</div>

		<!-- Right panel with reveal effect-->
		<!-- <div class="panel panel-right panel-reveal theme-dark">
			<div class="view">
				<div class="page">
					<div class="navbar">
						<div class="navbar-bg"></div>
						<div class="navbar-inner">
							<div class="title">Right Panel</div>
						</div>
					</div>
					<div class="page-content">
						<div class="block">Right panel content goes here</div>
					</div>
				</div>
			</div>
		</div> -->

		<!-- Your main view, should have "view-main" class -->
		<div class="view view-main view-init safe-areas" data-url="/"></div>

		<!-- Popup -->
		<!-- <div class="popup" id="my-popup">
			<div class="view">
				<div class="page">
					<div class="navbar">
						<div class="navbar-bg"></div>
						<div class="navbar-inner">
							<div class="title">Popup</div>
							<div class="right">
								<a href="#" class="link popup-close">Close</a>
							</div>
						</div>
					</div>
					<div class="page-content">
						<div class="block">
							<p>Popup content goes here.</p>
						</div>
					</div>
				</div>
			</div>
		</div> -->

		<!-- Login Screen -->
		<!-- <div class="login-screen" id="my-login-screen">
			<div class="view">
				<div class="page">
					<div class="page-content login-screen-content">
						<div class="login-screen-title">Login</div>
						<div class="list">
							<ul>
								<li class="item-content item-input">
									<div class="item-inner">
										<div class="item-title item-label">
											Username
										</div>
										<div class="item-input-wrap">
											<input
											type="text"
											name="username"
											placeholder="Your username"
											value="{{username}}"
											@input="updateUsername"
											/>
										</div>
									</div>
								</li>
								<li class="item-content item-input">
									<div class="item-inner">
										<div class="item-title item-label">
											Password
										</div>
										<div class="item-input-wrap">
											<input
											type="password"
											name="password"
											placeholder="Your password"
											value="{{password}}"
											@input="updatePassword"
											/>
										</div>
									</div>
								</li>
							</ul>
						</div>
						<div class="list">
							<ul>
								<li>
									<a
									href="#"
									class="item-link list-button login-button"
									@click="alertLoginData"
									>Sign In</a
									>
								</li>
							</ul>
							<div class="block-footer">
								Some text about login information.<br />Click
								"Sign In" to close Login Screen
							</div>
						</div>
					</div>
				</div>
			</div>
		</div> -->
	</div>
</template>
<script>
    import $$ from "dom7";
    export default {
        data() {
            return {
                user: {
                    firstName: "John",
                    lastName: "Doe",
                },
                // Login screen demo data
                username: "",
                password: "",
            };
        },
        methods: {
            helloWorld() {
                this.$f7.dialog.alert("Hello World!");
            },
            updateUsername(e) {
                this.username = e.target.value;
                this.$update();
            },
            updatePassword(e) {
                this.password = e.target.value;
                this.$update();
            },
            alertLoginData() {
                this.$f7.dialog.alert("Username: " + this.username + "<br>Password: " + this.password, () => {
                    this.$f7.loginScreen.close();
                });
            },
        },
        on: {
            pageInit: async function() {
                var self = this;
                var app = self.$app;
                var loggedUser = null;
                // console.log(app.views.main.router.url);
                if (app.views.main.router.url != "/") {
                    // console.log(loggedUser);
                    loggedUser = await updateUser();

                    updateControls();

                    $$("#edit-profile").off("click").on("click", async function(e) {
                        app.views.main.router.navigate(`/user/edit/${loggedUser.id}`);
                    });

                    $$("#sign-out-btn").off("click").on("click", async function(e) {
                        e.preventDefault();
                        loggedUser = null;
                        await app.methods.clearCurrentUser();
                        console.log("User cleared [app.f7.signout]");
                        await app.views.main.router.navigate('/');
                        // console.log("Logging out [pageInit.sign-out-btn.onClick]");
                        // if (await app.methods.setLocalValueToKey(null, 'loggedUser'))
                        // {
                        // 	console.log("Successfully logged out! [pageInit.sign-out-btn.onClick]");
                        // 	app.views.main.router.navigate({ name: "login" });
                        // }
                    })

                    $$('#lenguage').click(function(elem) {
                        let leng = "";
                        let val = $$(this).text();
                        if (val == 'English (US)') {
                            leng = 'en_US';
                        } else if (val == 'Espa√±ol (MX)') {
                            leng = 'es_MX';
                        }
                        localStorage.setItem('language', leng)
                        window.language = leng;
                        if (window.language == '') {
                            window.language = 'en_US';
                        }
                        self.$update();
                        app.views.main.router.refreshPage();
                        /* app.views.main.router.refreshPage() */
                        //let leng = ''
                        //localStorage.setItem('language',e.target.value)
                        //window.language = e.target.value;
                        //self.$update();
                    })

                    async function updateUser() {
                        let auxUser = await app.methods.getLocalValue("loggedUser");
                        // console.log(auxUser);
                        return auxUser;
                    }

                    function updateControls() {
                        // console.log("Updating controls [pageInit.updateControls()]");
                        if (loggedUser != null) {
                            var currentMembership = loggedUser.currentMembership;
                            if (currentMembership === null || currentMembership.plan === null) {
                                if (window.language == 'en_US') {
                                    currentMembership = 'No ' + window.localize('membership');
                                } else if (window.language == 'es_MX') {
                                    currentMembership = 'Sin ' + window.localize('membership');
                                }
                                //currentMembership = "No Membership";
                            } else {
                                if (window.language == 'en_US') {
                                    currentMembership = loggedUser.currentMembership.plan.name + " " + window.localize('membership');
                                } else if (window.language == 'es_MX') {
                                    currentMembership = window.localize('membership') + " " + loggedUser.currentMembership.plan.name;
                                } else {
                                    currentMembership = loggedUser.currentMembership.plan.name + " " + window.localize('membership');
                                }
                                //currentMembership = loggedUser.currentMembership.plan.name + " membership";
                            }

                            $$("#side-logged-user-name")[0].textContent = loggedUser.name != undefined ? loggedUser.name : loggedUser.username;
                            $$("#side-logged-user-membership")[0].textContent = currentMembership;
                            $$("#profile-btn")[0].href = ``;
                            if (loggedUser.profilePicture != null) {
                                $$("#side-logged-user-picture")[0].src = `${app.data.server}${loggedUser.profilePicture.url}`;
                            }

                            $$("#app-plan-button")[0].href = `/membership/view/user/${loggedUser.id}`;
                        } else {
                            currentMembership = "No membership";
                            $$("#side-logged-user-name")[0].textContent = "No user";
                            $$("#side-logged-user-membership")[0].textContent = "No membership";
                            $$("#side-logged-user-picture")[0].src = ``;
                        }
                    }
                }
            },
        },
    };
</script>